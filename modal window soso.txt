import streamlit as st
import pandas as pd
import glob
import os
import re
import base64

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ---
st.set_page_config(page_title="DENE Store", layout="wide")

# --- –û–±–ª–æ–∂–∫–∞ ---
st.image("data/images/banner.jpg", width="stretch")
st.markdown("<h1 style='text-align:center; white-space: nowrap;'>DENE Store. –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h1>", unsafe_allow_html=True)

# --- –ü—É—Ç–∏ –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã ---
CATALOG_PATH = "data/catalog.xlsx"
IMAGES_PATH = "data/images"

# --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º–∏ ---
def get_image_path(image_names):
    """–ò—â–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ –∏–º–µ–Ω–∏ –∏–∑ –∫–æ–ª–æ–Ω–∫–∏ image (–±–µ—Ä–µ—Ç –ø–µ—Ä–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞)"""
    if not image_names or pd.isna(image_names) or str(image_names).strip() == "":
        return os.path.join(IMAGES_PATH, "no_image.jpg")
    
    # –†–∞–∑–±–∏–≤–∞–µ–º —Å—Ç—Ä–æ–∫—É –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞ —Ñ–∞–π–ª–æ–≤ –∏ –±–µ—Ä–µ–º –ø–µ—Ä–≤–æ–µ
    image_names_list = str(image_names).strip().split()
    if not image_names_list:
        return os.path.join(IMAGES_PATH, "no_image.jpg")
    
    first_image_name = image_names_list[0]  # –ë–µ—Ä–µ–º –ø–µ—Ä–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    
    # –ò—â–µ–º —Ñ–∞–π–ª —Å —Ä–∞–∑–Ω—ã–º–∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è–º–∏
    for ext in ['.jpg', '.jpeg', '.png', '.webp']:
        pattern = os.path.join(IMAGES_PATH, "**", f"{first_image_name}{ext}")
        image_files = glob.glob(pattern, recursive=True)
        if image_files:
            return image_files[0]
        
        # –¢–∞–∫–∂–µ –∏—â–µ–º —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å —ç—Ç–æ–≥–æ –∏–º–µ–Ω–∏
        pattern_start = os.path.join(IMAGES_PATH, "**", f"{first_image_name}*{ext}")
        image_files = glob.glob(pattern_start, recursive=True)
        if image_files:
            return image_files[0]
    
    # –ï—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º no_image
    return os.path.join(IMAGES_PATH, "no_image.jpg")

def get_image_base64(image_path):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ base64 –¥–ª—è –≤—Å—Ç–∞–≤–∫–∏ –≤ HTML"""
    try:
        with open(image_path, "rb") as img_file:
            return base64.b64encode(img_file.read()).decode("utf-8")
    except Exception:
        fallback = os.path.join(IMAGES_PATH, "no_image.jpg")
        with open(fallback, "rb") as img_file:
            return base64.b64encode(img_file.read()).decode("utf-8")

# --- –¢–∞–±–ª–∏—Ü–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ —Ä–∞–∑–º–µ—Ä–æ–≤ US ‚Üî EU ---
size_conversion = {
    "6": "39", "6.5": "39.5", "7": "40", "7.5": "40.5",
    "8": "41", "8.5": "42", "9": "42.5", "9.5": "43",
    "10": "44", "10.5": "44.5", "11": "45", "11.5": "46", "12": "46.5"
}
reverse_conversion = {v: k for k, v in size_conversion.items()}

# --- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö ---
@st.cache_data(show_spinner=False)
def load_data():
    # –ß–∏—Ç–∞–µ–º –≤—Å–µ –ª–∏—Å—Ç—ã Excel —Ñ–∞–π–ª–∞
    all_sheets = pd.read_excel(CATALOG_PATH, sheet_name=None)
    
    # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ –ª–∏—Å—Ç—ã –≤ –æ–¥–∏–Ω DataFrame
    df_list = []
    for sheet_name, sheet_data in all_sheets.items():
        st.sidebar.write(f"üìã –õ–∏—Å—Ç '{sheet_name}': {len(sheet_data)} —Ç–æ–≤–∞—Ä–æ–≤")
        df_list.append(sheet_data)
    
    # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
    df = pd.concat(df_list, ignore_index=True)
    df = df.fillna("")

    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–æ–¥–µ–ª–∏
    df["model_clean"] = (
        df["model"]
        .str.replace(r"\d{1,2}(\.\d)?(US|EU)", "", regex=True)
        .str.strip()
    )

    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã
    df["size_us"] = df["model"].apply(lambda x: re.search(r"(\d{1,2}(\.\d)?)(?=US)", x))
    df["size_us"] = df["size_us"].apply(lambda m: m.group(1) if m else "")
    df["size_eu"] = df["model"].apply(lambda x: re.search(r"(\d{2}(\.\d)?)(?=EU)", x))
    df["size_eu"] = df["size_eu"].apply(lambda m: m.group(1) if m else "")

    # –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –æ–¥–Ω–æ–≥–æ –∏–∑ —Ä–∞–∑–º–µ—Ä–æ–≤
    df["size_eu"] = df.apply(lambda r: size_conversion.get(r["size_us"], r["size_eu"]), axis=1)
    df["size_us"] = df.apply(lambda r: reverse_conversion.get(r["size_eu"], r["size_us"]), axis=1)

    # –ü–æ–ª –∏ —Ü–≤–µ—Ç
    df["gender"] = df["model"].apply(
        lambda x: "men" if "men" in x.lower() else (
            "women" if "women" in x.lower() else "unisex"
        )
    )
    df["color"] = df["model"].str.extract(
        r"(white|black|blue|red|green|pink|gray|brown)", expand=False
    ).fillna("other")

    # –û–ø–∏—Å–∞–Ω–∏–µ
    if "description" not in df.columns:
        df["description"] = "–û–ø–∏—Å–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ."

    # –ò—Å–∫–ª—é—á–∞–µ–º —Ç–æ–≤–∞—Ä—ã –±–µ–∑ —Ü–µ–Ω—ã –∏–ª–∏ –º–æ–¥–µ–ª–∏
    df = df[df["price"].astype(str).str.strip() != ""]
    df = df[df["model_clean"].astype(str).str.strip() != ""]

    return df

# --- –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ---
df = load_data()

# --- –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê ---
st.sidebar.write("üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê:")
st.sidebar.write("–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ—Å–ª–µ –æ–±—ä–µ–¥–∏–Ω–µ–Ω–∏—è:", len(df))
st.sidebar.write("–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –±—Ä–µ–Ω–¥—ã:", df["brand"].nunique())
st.sidebar.write("–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏:", df["model_clean"].nunique())

# --- –§–∏–ª—å—Ç—Ä—ã ---
st.divider()
st.markdown("### üîé –§–∏–ª—å—Ç—Ä –∫–∞—Ç–∞–ª–æ–≥–∞")

col1, col2, col3, col4, col5, col6 = st.columns(6)
brand_filter = col1.selectbox("–ë—Ä–µ–Ω–¥", ["–í—Å–µ"] + sorted(df["brand"].unique().tolist()))
filtered_df = df if brand_filter == "–í—Å–µ" else df[df["brand"] == brand_filter]

models = sorted(filtered_df["model_clean"].unique().tolist())
model_filter = col2.selectbox("–ú–æ–¥–µ–ª—å", ["–í—Å–µ"] + models)

size_us_filter = col3.selectbox("–†–∞–∑–º–µ—Ä (US)", ["–í—Å–µ"] + sorted(df["size_us"].dropna().unique().tolist()))
size_eu_filter = col4.selectbox("–†–∞–∑–º–µ—Ä (EU)", ["–í—Å–µ"] + sorted(df["size_eu"].dropna().unique().tolist()))
gender_filter = col5.selectbox("–ü–æ–ª", ["–í—Å–µ", "men", "women", "unisex"])
color_filter = col6.selectbox("–¶–≤–µ—Ç", ["–í—Å–µ"] + sorted(df["color"].dropna().unique().tolist()))

# --- –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã ---
filtered_df = df.copy()
if brand_filter != "–í—Å–µ":
    filtered_df = filtered_df[filtered_df["brand"] == brand_filter]
if model_filter != "–í—Å–µ":
    filtered_df = filtered_df[filtered_df["model_clean"] == model_filter]
if size_us_filter != "–í—Å–µ":
    eu_equiv = size_conversion.get(size_us_filter, "")
    filtered_df = filtered_df[
        (filtered_df["size_us"] == size_us_filter) | (filtered_df["size_eu"] == eu_equiv)
    ]
if size_eu_filter != "–í—Å–µ":
    us_equiv = reverse_conversion.get(size_eu_filter, "")
    filtered_df = filtered_df[
        (filtered_df["size_eu"] == size_eu_filter) | (filtered_df["size_us"] == us_equiv)
    ]
if gender_filter != "–í—Å–µ":
    filtered_df = filtered_df[filtered_df["gender"] == gender_filter]
if color_filter != "–í—Å–µ":
    filtered_df = filtered_df[filtered_df["color"] == color_filter]

st.divider()

# --- –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ ---
if "selected_product" not in st.session_state:
    st.session_state.selected_product = None

# --- –°–µ—Ç–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–æ–≤–∞—Ä–æ–≤ ---
st.markdown("## üëü –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤")

if len(filtered_df) == 0:
    st.warning("üö´ –¢–æ–≤–∞—Ä—ã –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
else:
    st.write(f"**–ù–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: {len(filtered_df)}**")

    num_cols = 4
    rows = [filtered_df.iloc[i:i + num_cols] for i in range(0, len(filtered_df), num_cols)]

    for row_df in rows:
        cols = st.columns(num_cols)
        for col, (_, row) in zip(cols, row_df.iterrows()):
            with col:
                image_path = get_image_path(row["image"])
                image_base64 = get_image_base64(image_path)

                # --- –ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞ ---
                st.markdown(
                    f"""
                    <div style="
                        border:1px solid #eee;
                        border-radius:16px;
                        padding:12px;
                        margin-bottom:16px;
                        background-color:#fff;
                        box-shadow:0 2px 10px rgba(0,0,0,0.05);
                    ">
                        <img src="data:image/jpeg;base64,{image_base64}" 
                             style='width:100%; border-radius:12px; object-fit:cover; height:220px;'>
                        <h4 style="margin:10px 0 4px 0;">{row['brand']} {row['model_clean']}</h4>
                        <p style="color:gray; font-size:13px; margin:0;">
                            US {row['size_us'] or '-'} | EU {row['size_eu'] or '-'} | {row['color']}
                        </p>
                        <p style="font-size:14px; color:#555;">{row['description']}</p>
                        <p style="font-weight:bold; font-size:16px; margin-top:6px;">{int(row['price'])} ‚Ç∏</p>
                    """,
                    unsafe_allow_html=True
                )

                # --- –ö–Ω–æ–ø–∫–∞ –ü–æ–¥—Ä–æ–±–Ω–µ–µ ---
                if st.button(f"–ü–æ–¥—Ä–æ–±–Ω–µ–µ üßê", key=f"details_{row.name}_{row['brand']}_{row['model_clean']}"):
                    st.session_state.selected_product = row

# --- –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ ---
if "selected_product" not in st.session_state:
    st.session_state.selected_product = None

# --- –°–µ—Ç–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–æ–≤–∞—Ä–æ–≤ ---
st.markdown("## üëü –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤")

if len(filtered_df) == 0:
    st.warning("üö´ –¢–æ–≤–∞—Ä—ã –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
else:
    st.write(f"**–ù–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: {len(filtered_df)}**")

    num_cols = 4
    rows = [filtered_df.iloc[i:i + num_cols] for i in range(0, len(filtered_df), num_cols)]

    for row_df in rows:
        cols = st.columns(num_cols)
        for col, (_, row) in zip(cols, row_df.iterrows()):
            with col:
                image_path = get_image_path(row["image"])
                image_base64 = get_image_base64(image_path)

                st.markdown(
                    f"""
                    <div style="
                        border:1px solid #eee;
                        border-radius:16px;
                        padding:12px;
                        margin-bottom:16px;
                        background-color:#fff;
                        box-shadow:0 2px 10px rgba(0,0,0,0.05);
                    ">
                        <img src="data:image/jpeg;base64,{image_base64}" 
                             style='width:100%; border-radius:12px; object-fit:cover; height:220px;'>
                        <h4 style="margin:10px 0 4px 0;">{row['brand']} {row['model_clean']}</h4>
                        <p style="color:gray; font-size:13px; margin:0;">
                            US {row['size_us'] or '-'} | EU {row['size_eu'] or '-'} | {row['color']}
                        </p>
                        <p style="font-size:14px; color:#555;">{row['description']}</p>
                        <p style="font-weight:bold; font-size:16px; margin-top:6px;">{int(row['price'])} ‚Ç∏</p>
                    """,
                    unsafe_allow_html=True
                )

                if st.button(f"–ü–æ–¥—Ä–æ–±–Ω–µ–µ üßê", key=f"details_{row.name}"):
                    st.session_state.selected_product = row

# --- –í—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ –ø–æ–≤–µ—Ä—Ö ---
if st.session_state.selected_product is not None:
    row = st.session_state.selected_product

    # –í—Å–µ —Ñ–æ—Ç–æ —ç—Ç–æ–π –º–æ–¥–µ–ª–∏
    all_images = []
    if row["image"]:
        image_names_list = str(row["image"]).strip().split()
        for img_name in image_names_list:
            for ext in ['.jpg', '.jpeg', '.png', '.webp']:
                pattern = os.path.join(IMAGES_PATH, "**", f"{img_name}*{ext}")
                files = glob.glob(pattern, recursive=True)
                all_images.extend(files)
    if not all_images:
        all_images = [os.path.join(IMAGES_PATH, "no_image.jpg")]

    # HTML –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–≤–µ—Ä—Ö
    modal_html = f"""
    <div id="overlay" style="
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background-color: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    ">
      <div style="
          background: white;
          border-radius: 16px;
          padding: 20px;
          width: 90%;
          max-width: 800px;
          max-height: 90%;
          overflow-y: auto;
          box-shadow: 0 4px 30px rgba(0,0,0,0.3);
          position: relative;
      ">
        <button onclick="document.getElementById('overlay').remove()" style="
            position: absolute;
            top: 10px; right: 10px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 6px 10px;
            cursor: pointer;
        ">‚úñ</button>
        <h2>{row['brand']} {row['model_clean']}</h2>
        <p><b>–¶–µ–Ω–∞:</b> {int(row['price'])} ‚Ç∏</p>
        <p><b>–†–∞–∑–º–µ—Ä—ã:</b> US {row['size_us']} | EU {row['size_eu']}</p>
        <p><b>–ü–æ–ª:</b> {row['gender']} | <b>–¶–≤–µ—Ç:</b> {row['color']}</p>
        <p><b>–û–ø–∏—Å–∞–Ω–∏–µ:</b> {row['description']}</p>
        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">
    """

    for img_path in all_images:
        with open(img_path, "rb") as f:
            b64 = base64.b64encode(f.read()).decode()
            modal_html += f"<img src='data:image/jpeg;base64,{b64}' style='width:180px; border-radius:12px;'>"

    # –¶–≤–µ—Ç–æ–≤—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
    color_variants = df[df["model_clean"] == row["model_clean"]].drop_duplicates("color")
    if len(color_variants) > 1:
        modal_html += "<h3>üé® –í–∞—Ä–∏–∞–Ω—Ç—ã —Ü–≤–µ—Ç–∞:</h3><div style='display:flex; gap:8px; flex-wrap:wrap;'>"
        for _, variant in color_variants.iterrows():
            img_path = get_image_path(variant["image"])
            with open(img_path, "rb") as f:
                b64v = base64.b64encode(f.read()).decode()
            modal_html += f"""
            <div style='text-align:center;'>
                <img src='data:image/jpeg;base64,{b64v}' style='width:100px; border-radius:8px;'>
                <p style='margin-top:4px; font-size:13px;'>{variant['color']}</p>
            </div>
            """
        modal_html += "</div>"

    modal_html += "</div></div>"

    st.markdown(modal_html, unsafe_allow_html=True)

st.divider()
st.caption("¬© DENE Store 2025")