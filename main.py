import os
import pandas as pd
import streamlit as st
import glob

# üìÅ –ü—É—Ç–∏
CATALOG_PATH = os.path.join("data", "catalog.xlsx")
NO_IMAGE_PATH = os.path.join("data", "images", "no_image.jpg")

# üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞
def load_catalog():
    df = pd.read_excel(CATALOG_PATH)
    df.fillna('', inplace=True)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω—É–∂–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏
    for col in ['brand', 'model', 'SKU']:
        if col not in df.columns:
            df[col] = ''
    return df

catalog = load_catalog()

st.title("üõç –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤")

# üîç –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ —Ñ–æ—Ç–æ
def find_image(brand, model, sku):
    brand_path = os.path.join("data", "images", brand)
    model_path = os.path.join(brand_path, model)
    search_pattern = os.path.join(model_path, f"{sku}*.jpg")
    matches = glob.glob(search_pattern)
    if matches:
        return matches[0]  # –±–µ—Ä–µ–º –ø–µ—Ä–≤–æ–µ –Ω–∞–π–¥–µ–Ω–Ω–æ–µ —Ñ–æ—Ç–æ
    return NO_IMAGE_PATH

# üß© –í—ã–≤–æ–¥ –∫–∞—Ä—Ç–æ—á–µ–∫
for _, row in catalog.iterrows():
    brand = str(row['brand']).strip()
    model = str(row['model']).strip()
    sku = str(row['SKU']).strip()

    # --- –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –µ—Å–ª–∏ –Ω–µ—Ç SKU ---
    if not sku:
        continue

    # --- –§–æ—Ç–æ ---
    image_path = find_image(brand, model, sku)

    # --- –¶–µ–Ω–∞ ---
    price = str(row.get('price', '')).strip()
    price_html = f"<p style='font-size:16px; color:gray; margin:2px 0;'>{int(price)} ‚Ç∏</p>" if price.isdigit() else ""

    # --- –ú–æ–¥–µ–ª—å ---
    model_html = f"<p style='font-size:15px; color:#555; margin:2px 0;'>–ú–æ–¥–µ–ª—å: {model}</p>" if model else ""

    # --- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ ---
    st.markdown(f"""
    <div style="border:1px solid #ddd; border-radius:12px; padding:12px; margin:10px 0; background:#fff;">
        <img src="{image_path}" style="width:100%; border-radius:8px; margin-bottom:6px;">
        <p style="font-weight:bold; font-size:18px;">{brand}</p>
        {model_html}
        {price_html}
    </div>
    """, unsafe_allow_html=True)
