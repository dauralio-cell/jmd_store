import streamlit as st
import pandas as pd
import glob
import os

# ==============================
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
# ==============================
st.set_page_config(page_title="Sneaker Catalog", layout="wide")

# ==============================
# –û–±–ª–æ–∂–∫–∞
# ==============================
st.markdown(
    """
    <div style='text-align:center; padding:40px 0;'>
        <h1 style='font-size:48px; margin-bottom:10px;'>üèÅ Sneaker Catalog</h1>
        <p style='font-size:18px; color:gray;'>–ü–æ–∏—Å–∫ –ø–æ –±—Ä–µ–Ω–¥—É, —Ü–≤–µ—Ç—É, —Ä–∞–∑–º–µ—Ä—É –∏ —Ü–µ–Ω–µ</p>
    </div>
    """,
    unsafe_allow_html=True
)

# ==============================
# –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
# ==============================
@st.cache_data
def load_data():
    df = pd.read_csv("data/sneakers.csv")

    df["brand"] = df["brand"].fillna("").astype(str).str.strip()
    df["model_clean"] = df["model_clean"].fillna("").astype(str).str.strip()
    df["color"] = df["color"].fillna("").astype(str).str.strip()
    df["size_us"] = df["size_us"].fillna("")
    df["size_eu"] = df["size_eu"].fillna("")
    df["description"] = df["description"].fillna("")
    df["price"] = df["price"].fillna(0)
    df["SKU"] = df["SKU"].fillna("").astype(str).str.strip()
    return df

df = load_data()

# ==============================
# –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤
# ==============================
with st.sidebar:
    st.header("üîç –§–∏–ª—å—Ç—Ä—ã")

    brands = sorted(df["brand"].dropna().unique())
    brand_filter = st.multiselect("–ë—Ä–µ–Ω–¥", options=brands)

    colors = sorted(df["color"].dropna().unique())
    color_filter = st.multiselect("–¶–≤–µ—Ç", options=colors)

    sizes_us = sorted(df["size_us"].dropna().unique())
    size_us_filter = st.multiselect("–†–∞–∑–º–µ—Ä US", options=sizes_us)

    price_min, price_max = st.slider(
        "–¶–µ–Ω–∞ (‚Ç∏)", 
        int(df["price"].min()), 
        int(df["price"].max()), 
        (int(df["price"].min()), int(df["price"].max()))
    )

# ==============================
# –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
# ==============================
filtered_df = df.copy()
if brand_filter:
    filtered_df = filtered_df[filtered_df["brand"].isin(brand_filter)]
if color_filter:
    filtered_df = filtered_df[filtered_df["color"].isin(color_filter)]
if size_us_filter:
    filtered_df = filtered_df[filtered_df["size_us"].isin(size_us_filter)]

filtered_df = filtered_df[
    (filtered_df["price"] >= price_min) & (filtered_df["price"] <= price_max)
]

# ==============================
# –°–µ—Ç–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–æ–≤–∞—Ä–æ–≤
# ==============================
st.markdown("## üëü –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤")

num_cols = 4
rows = [filtered_df.iloc[i:i + num_cols] for i in range(0, len(filtered_df), num_cols)]

for row_df in rows:
    cols = st.columns(num_cols)
    for col, (_, row) in zip(cols, row_df.iterrows()):
        with col:
            # –ò—â–µ–º –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è SKU (–≤ –ª—é–±—ã—Ö –ø–æ–¥–ø–∞–ø–∫–∞—Ö –∏ —Ñ–æ—Ä–º–∞—Ç–∞—Ö)
            image_files = glob.glob(f"data/images/**/*{row['SKU']}*.*", recursive=True)
            image_files = [img for img in image_files if img.lower().endswith(('.jpg', '.jpeg', '.png', '.webp'))]

            # –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º no_image.jpg
            if not image_files:
                image_files = ["data/images/no_image.jpg"]

            main_image = image_files[0]

            # --- –ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞ ---
            st.markdown(
                f"""
                <div style="
                    border:1px solid #eee;
                    border-radius:16px;
                    padding:12px;
                    margin-bottom:16px;
                    background-color:#fff;
                    box-shadow:0 2px 10px rgba(0,0,0,0.05);
                    transition:transform 0.2s ease-in-out;
                " onmouseover="this.style.transform='scale(1.02)';"
                  onmouseout="this.style.transform='scale(1)';">
                    <img src='{main_image}' style='width:100%; border-radius:12px; object-fit:cover; height:220px;'>
                    <h4 style="margin:10px 0 4px 0;">{row['brand']} {row['model_clean']}</h4>
                    <p style="color:gray; font-size:13px; margin:0;">
                        US {row['size_us'] or '-'} | EU {row['size_eu'] or '-'} | {row['color']}
                    </p>
                    <p style="font-size:14px; color:#555;">{row['description']}</p>
                    <p style="font-weight:bold; font-size:16px; margin-top:6px;">{int(row['price'])} ‚Ç∏</p>
                </div>
                """,
                unsafe_allow_html=True
            )

            # --- –ì–∞–ª–µ—Ä–µ—è (–µ—Å–ª–∏ –µ—Å—Ç—å –¥–æ–ø. —Ñ–æ—Ç–æ) ---
            if len(image_files) > 1:
                with st.expander("üì∏ –î—Ä—É–≥–∏–µ —Ñ–æ—Ç–æ"):
                    st.image(image_files, use_container_width=True)

# ==============================
# –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
# ==============================
if filtered_df.empty:
    st.warning("‚ö†Ô∏è –¢–æ–≤–∞—Ä—ã –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.")
