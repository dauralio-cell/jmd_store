import streamlit as st
import pandas as pd
import re

# --- –û–±–ª–æ–∂–∫–∞ ---
st.image("data/images/banner.jpg", use_container_width=True)

# --- –ó–∞–≥–æ–ª–æ–≤–æ–∫ ---
st.markdown(
    """
    <style>
    .welcome-text {
        text-align: center;
        white-space: nowrap;
        font-weight: 600;
        margin-top: 10px;
        font-size: 2rem;
    }

    @media (max-width: 768px) {
        .welcome-text {
            font-size: 1.5rem;
        }
    }

    @media (max-width: 480px) {
        .welcome-text {
            font-size: 1.2rem;
        }
    }
    </style>

    <h2 class="welcome-text">DENE Store. –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
    """,
    unsafe_allow_html=True
)

# --- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö ---
@st.cache_data
def load_data():
    df = pd.read_excel("data/catalog.xlsx")
    df = df.fillna("")

    # --- –†–∞–∑–±–æ—Ä model ---
    df["brand"] = df["brand"].str.strip()

    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ä–∞–∑–º–µ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä, 6.5, 42, 43.5)
    df["size"] = df["model"].apply(lambda x: re.search(r"\b\d{1,2}(\.\d)?\b", str(x)).group(0) if re.search(r"\b\d{1,2}(\.\d)?\b", str(x)) else "")

    # –ò–∑–≤–ª–µ–∫–∞–µ–º –ø–æ–ª (men, women, kids –∏ —Ç.–ø.)
    df["gender"] = df["model"].apply(lambda x: "men" if "men" in str(x).lower() else ("women" if "women" in str(x).lower() else ""))

    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ü–≤–µ—Ç (–ø–æ —Å–ª–æ–≤–∞–º —Ç–∏–ø–∞ white, black, red, blue –∏ —Ç.–¥.)
    colors = ["white", "black", "red", "blue", "green", "grey", "pink", "yellow", "brown", "beige", "purple", "orange"]
    df["color"] = df["model"].apply(lambda x: next((c for c in colors if c in str(x).lower()), ""))

    # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ –±–µ–∑ –±—Ä–µ–Ω–¥–∞, —Ä–∞–∑–º–µ—Ä–∞ –∏ –ø–æ–ª–∞
    def clean_model(text):
        t = str(text)
        t = re.sub(r"(?i)\b(men|women|kids)\b", "", t)
        t = re.sub(r"\b\d{1,2}(\.\d)?\b", "", t)
        t = re.sub(r"\b(" + "|".join(colors) + r")\b", "", t, flags=re.IGNORECASE)
        return t.replace("  ", " ").strip()

    df["model_clean"] = df["model"].apply(clean_model)
    return df

df = load_data()

# --- –§–∏–ª—å—Ç—Ä—ã ---
st.sidebar.header("–§–∏–ª—å—Ç—Ä —Ç–æ–≤–∞—Ä–æ–≤")

brands = ["–í—Å–µ"] + sorted(df["brand"].unique().tolist())
selected_brand = st.sidebar.selectbox("–ë—Ä–µ–Ω–¥", brands)

# –ü–æ—è–≤–ª—è–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –±—Ä–µ–Ω–¥–∞
if selected_brand != "–í—Å–µ":
    models = ["–í—Å–µ"] + sorted(df[df["brand"] == selected_brand]["model_clean"].unique().tolist())
else:
    models = ["–í—Å–µ"] + sorted(df["model_clean"].unique().tolist())
selected_model = st.sidebar.selectbox("–ú–æ–¥–µ–ª—å", models)

sizes = ["–í—Å–µ"] + sorted(df["size"].unique().tolist(), key=lambda x: (float(x) if x else 0))
selected_size = st.sidebar.selectbox("–†–∞–∑–º–µ—Ä", sizes)

genders = ["–í—Å–µ"] + sorted([g for g in df["gender"].unique() if g])
selected_gender = st.sidebar.selectbox("–ü–æ–ª", genders)

colors = ["–í—Å–µ"] + sorted([c for c in df["color"].unique() if c])
selected_color = st.sidebar.selectbox("–¶–≤–µ—Ç", colors)

# --- –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤ ---
filtered = df.copy()
if selected_brand != "–í—Å–µ":
    filtered = filtered[filtered["brand"] == selected_brand]
if selected_model != "–í—Å–µ":
    filtered = filtered[filtered["model_clean"] == selected_model]
if selected_size != "–í—Å–µ":
    filtered = filtered[filtered["size"] == selected_size]
if selected_gender != "–í—Å–µ":
    filtered = filtered[filtered["gender"] == selected_gender]
if selected_color != "–í—Å–µ":
    filtered = filtered[filtered["color"] == selected_color]

# --- –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ ---
st.markdown("### –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤")

if filtered.empty:
    st.info("–¢–æ–≤–∞—Ä—ã –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –Ω–µ –Ω–∞–π–¥–µ–Ω—ã üò¢")
else:
    cols = st.columns(3)
    for i, (_, row) in enumerate(filtered.iterrows()):
        with cols[i % 3]:
            image_path = f"data/images/{row['SKU']}.jpg"
            st.image(image_path, use_container_width=True, caption=row["model_clean"])
            st.write(f"**{row['brand']}** ‚Äî {row['model_clean']}")
            st.write(f"üí∞ –¶–µ–Ω–∞: {int(row['price'])} ‚Ç∏")
            st.button("üõí –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É", key=f"btn_{i}")
