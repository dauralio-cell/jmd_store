import streamlit as st
import pandas as pd
import os
import glob
from PIL import Image

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ---
st.set_page_config(page_title="DENE Store", layout="wide")

# --- –û–±–ª–æ–∂–∫–∞ ---
banner_path = "data/images/banner.jpg"
if os.path.exists(banner_path):
    st.image(banner_path, use_container_width=True)
st.markdown("<h1 style='text-align:center;'>DENE Store. –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h1>", unsafe_allow_html=True)

# --- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö ---
df = pd.read_excel("data/catalog.xlsx")

# --- –û—á–∏—Å—Ç–∫–∞ –Ω–∞–∑–≤–∞–Ω–∏–π –∫–æ–ª–æ–Ω–æ–∫ ---
df.columns = df.columns.str.strip().str.lower()

# --- –ü—Ä–æ–≤–µ—Ä–∏–º –Ω–∞–ª–∏—á–∏–µ –∫–ª—é—á–µ–≤—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ ---
required_columns = ["brand", "model", "gender", "size us", "price", "in stock", "image"]
for col in required_columns:
    if col not in df.columns:
        st.error(f"‚ùå –í —Ç–∞–±–ª–∏—Ü–µ –Ω–µ—Ç –∫–æ–ª–æ–Ω–∫–∏: '{col}'")
        st.stop()

# --- –§–∏–ª—å—Ç—Ä—ã ---
col1, col2, col3, col4 = st.columns(4)

brands = sorted(df["brand"].dropna().unique().tolist())
models = sorted(df["model"].dropna().unique().tolist())
genders = sorted(df["gender"].dropna().unique().tolist())
sizes = sorted(df["size us"].dropna().unique().tolist())

brand_filter = col1.selectbox("–ë—Ä–µ–Ω–¥", ["–í—Å–µ"] + brands)
model_filter = col2.selectbox("–ú–æ–¥–µ–ª—å", ["–í—Å–µ"] + models)
gender_filter = col3.selectbox("–ü–æ–ª", ["–í—Å–µ"] + genders)
size_filter = col4.selectbox("–†–∞–∑–º–µ—Ä US", ["–í—Å–µ"] + sizes)

filtered_df = df.copy()
if brand_filter != "–í—Å–µ":
    filtered_df = filtered_df[filtered_df["brand"] == brand_filter]
if model_filter != "–í—Å–µ":
    filtered_df = filtered_df[filtered_df["model"] == model_filter]
if gender_filter != "–í—Å–µ":
    filtered_df = filtered_df[filtered_df["gender"] == gender_filter]
if size_filter != "–í—Å–µ":
    filtered_df = filtered_df[filtered_df["size us"] == size_filter]

# --- –°–∫–∞–Ω–∏—Ä—É–µ–º –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ data/images ---
image_paths = glob.glob("data/images/**/*.*", recursive=True)
image_map = {}
for path in image_paths:
    name = os.path.splitext(os.path.basename(path))[0]
    image_map[name] = path

# --- –í—ã–≤–æ–¥ –∫–∞—Ä—Ç–æ—á–µ–∫ ---
st.markdown("### –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤")
if filtered_df.empty:
    st.warning("üòï –ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º.")
else:
    cols = st.columns(4)
    for idx, (_, row) in enumerate(filtered_df.iterrows()):
        with cols[idx % 4]:
            images = str(row["image"]).split()
            found_images = []
            for img_name in images:
                if img_name in image_map:
                    found_images.append(image_map[img_name])
            
            if found_images:
                st.image(found_images[0], use_container_width=True)
            else:
                st.image("data/images/no_image.jpg", use_container_width=True)

            st.markdown(f"**{row['brand']} {row['model']}**")
            st.markdown(f"–†–∞–∑–º–µ—Ä: {row['size us']}")
            st.markdown(f"–¶–µ–Ω–∞: {int(row['price'])} ‚Ç∏")

            color = "green" if str(row["in stock"]).strip().lower() == "yes" else "red"
            st.markdown(f"<p style='font-size:13px; color:{color};'>–í –Ω–∞–ª–∏—á–∏–∏: {row['in stock']}</p>", unsafe_allow_html=True)
