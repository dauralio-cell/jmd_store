from flask import Flask, request
import telebot
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton
from database import init_db, get_all_products, add_product

# üîπ –ù–∞—Å—Ç—Ä–æ–π–∫–∏
BOT_TOKEN = "8436596875:AAGvAemmT1ESKk7dflMbTbjzz_n49LRckEc"
WEBHOOK_URL = f"https://jmd-store.onrender.com/{BOT_TOKEN}"

bot = telebot.TeleBot(BOT_TOKEN)
app = Flask(__name__)

# ===================================================
# Flask ‚Äî —Å–∞–π—Ç –∏ –≤–µ–±—Ö—É–∫
# ===================================================
@app.route("/")
def home():
    return "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∞–≥–∞–∑–∏–Ω DENE! üõç"

@app.route("/" + BOT_TOKEN, methods=["POST"])
def webhook():
    json_str = request.get_data().decode("UTF-8")
    update = telebot.types.Update.de_json(json_str)
    bot.process_new_updates([update])
    return "OK", 200

@app.route("/setwebhook")
def set_webhook():
    bot.remove_webhook()
    bot.set_webhook(url=WEBHOOK_URL)
    return f"Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ ‚úÖ\n{WEBHOOK_URL}", 200

# ===================================================
# Telegram Bot
# ===================================================
@bot.message_handler(commands=["start"])
def cmd_start(message):
    kb = InlineKeyboardMarkup()
    kb.add(InlineKeyboardButton("–û—Ç–∫—Ä—ã—Ç—å –∫–∞—Ç–∞–ª–æ–≥", callback_data="catalog"))
    bot.send_message(
        message.chat.id,
        f"–ü—Ä–∏–≤–µ—Ç, {message.from_user.first_name}! üëã\n"
        f"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∞–≥–∞–∑–∏–Ω DENE.\n"
        f"–í—ã–±–µ—Ä–∏ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∏–∂–µ üëá",
        reply_markup=kb
    )

@bot.callback_query_handler(func=lambda call: call.data == "catalog")
def show_catalog(call):
    products = [
        ("Nike Air Force 1", "65 000 —Ç–≥", "–†–∞–∑–º–µ—Ä—ã 40‚Äì45, –±–µ–ª—ã–µ"),
        ("Adidas Yeezy Boost 350", "90 000 —Ç–≥", "–†–∞–∑–º–µ—Ä—ã 39‚Äì44, —Å–µ—Ä—ã–µ"),
        ("New Balance 550", "75 000 —Ç–≥", "–†–∞–∑–º–µ—Ä—ã 40‚Äì45, –±–µ–ª–æ-–∑–µ–ª–µ–Ω—ã–µ")
    ]

    bot.send_message(call.message.chat.id, "üëü –ö–∞—Ç–∞–ª–æ–≥ DENE:\n")

    for name, price, info in products:
        text = f"üè∑ {name}\nüí∞ –¶–µ–Ω–∞: {price}\nüìè {info}"
        kb = InlineKeyboardMarkup()
        kb.add(InlineKeyboardButton("üõí –ó–∞–∫–∞–∑–∞—Ç—å", callback_data=f"order_{name}"))
        bot.send_message(call.message.chat.id, text, reply_markup=kb)

@bot.callback_query_handler(func=lambda call: call.data.startswith("order_"))
def order_product(call):
    product_name = call.data.replace("order_", "")
    bot.send_message(call.message.chat.id, f"‚úÖ –¢–æ–≤–∞—Ä ¬´{product_name}¬ª –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É (—Ç–µ—Å—Ç).")

# ===================================================
# –ó–∞–ø—É—Å–∫
# ===================================================
if __name__ == "__main__":
    init_db()
    print("‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≥–æ—Ç–æ–≤–∞")
    app.run(host="0.0.0.0", port=5000)