import streamlit as st
import pandas as pd
import os
import glob
from PIL import Image

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ---
st.set_page_config(page_title="DENE Store", layout="wide")

# --- –û–±–ª–æ–∂–∫–∞ ---
if os.path.exists("data/images/banner.jpg"):
    st.image("data/images/banner.jpg", use_container_width=True)
st.markdown("<h1 style='text-align:center;'>DENE Store ‚Äî –ö–∞—Ç–∞–ª–æ–≥</h1>", unsafe_allow_html=True)
st.write("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–¥–æ–±—Ä–∞—Ç—å –∫—Ä–æ—Å—Å–æ–≤–∫–∏ –ø–æ –±—Ä–µ–Ω–¥—É, –º–æ–¥–µ–ª–∏, —Ä–∞–∑–º–µ—Ä—É –∏ –ø–æ–ª—É üëü")

# --- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö ---
@st.cache_data
def load_data():
    df = pd.read_excel("data/catalog.xlsx")
    df = df.fillna("")
    return df

df = load_data()

# --- –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ---
image_files = glob.glob("data/images/**/*.*", recursive=True)
image_index = {}
for img_path in image_files:
    base = os.path.splitext(os.path.basename(img_path))[0].lower()
    image_index[base] = img_path

# --- –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–æ–≤ ---
with st.expander("üîé –§–∏–ª—å—Ç—Ä —Ç–æ–≤–∞—Ä–æ–≤", expanded=True):
    col1, col2, col3, col4 = st.columns(4)
    with col1:
        brand_filter = st.selectbox("–ë—Ä–µ–Ω–¥", ["–í—Å–µ"] + sorted(df["brand"].dropna().unique().tolist()))
    with col2:
        model_filter = st.selectbox("–ú–æ–¥–µ–ª—å", ["–í—Å–µ"] + sorted(df["model"].dropna().unique().tolist()))
    with col3:
        size_filter = st.selectbox("–†–∞–∑–º–µ—Ä", ["–í—Å–µ"] + sorted(df["size"].dropna().unique().tolist()))
    with col4:
        gender_filter = st.selectbox("–ü–æ–ª", ["–í—Å–µ"] + sorted(df["gender"].dropna().unique().tolist()))

search_query = st.text_input("üîç –ü–æ–∏—Å–∫ –ø–æ –±—Ä–µ–Ω–¥—É –∏–ª–∏ –º–æ–¥–µ–ª–∏").strip().lower()

# --- –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã ---
filtered_df = df.copy()
if brand_filter != "–í—Å–µ":
    filtered_df = filtered_df[filtered_df["brand"] == brand_filter]
if model_filter != "–í—Å–µ":
    filtered_df = filtered_df[filtered_df["model"] == model_filter]
if size_filter != "–í—Å–µ":
    filtered_df = filtered_df[filtered_df["size"] == size_filter]
if gender_filter != "–í—Å–µ":
    filtered_df = filtered_df[filtered_df["gender"] == gender_filter]
if search_query:
    filtered_df = filtered_df[
        filtered_df["brand"].str.lower().str.contains(search_query) |
        filtered_df["model"].str.lower().str.contains(search_query)
    ]

# --- –í—ã–≤–æ–¥ –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–æ–≤–∞—Ä–æ–≤ ---
if filtered_df.empty:
    st.warning("‚ùå –¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –ø–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É.")
else:
    cols = st.columns(3)
    for idx, (_, row) in enumerate(filtered_df.iterrows()):
        # --- –ü–æ–∏—Å–∫ –∫–∞—Ä—Ç–∏–Ω–∫–∏ ---
        images = str(row.get("image", "")).split()
        found_image = None
        for name in images:
            key = name.strip().lower()
            if key in image_index:
                found_image = image_index[key]
                break
        if not found_image:
            found_image = "data/images/no_image.jpg"

        with cols[idx % 3]:
            st.image(found_image, use_container_width=True)
            st.markdown(
                f"""
                <div style="
                    border:1px solid #eee;
                    border-radius:16px;
                    padding:12px;
                    margin-top:8px;
                    background-color:#fff;
                    box-shadow:0 2px 8px rgba(0,0,0,0.05);
                    text-align:center;
                ">
                    <h4 style="margin:4px 0;">{row.get('brand','')} {row.get('model','')}</h4>
                    <p style="color:gray; font-size:13px; margin:2px 0;">{row.get('color','')} | {row.get('gender','')}</p>
                    <p style="font-weight:bold; color:#111; margin:4px 0;">{int(row.get('price',0))} ‚Ç∏</p>
                    <p style="font-size:13px; color:{'green' if str(row.get('in stock', 'yes')).lower() in ['yes','–≤ –Ω–∞–ª–∏—á–∏–∏','true'] else 'red'};">
                        {'–í –Ω–∞–ª–∏—á–∏–∏' if str(row.get('in stock', 'yes')).lower() in ['yes','–≤ –Ω–∞–ª–∏—á–∏–∏','true'] else '–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏'}
                    </p>
                </div>
                """,
                unsafe_allow_html=True
            )
