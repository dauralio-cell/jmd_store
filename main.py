import os
import pandas as pd
import streamlit as st
import glob
import re

# === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ===
st.set_page_config(page_title="DENE Store", layout="wide")

# === –ü—É—Ç–∏ ===
CATALOG_PATH = os.path.join("data", "catalog.xlsx")
NO_IMAGE_PATH = os.path.join("data", "images", "no_image.jpg")

# === –û–±–ª–æ–∂–∫–∞ ===
st.image("data/images/banner.jpg", width="stretch")
st.markdown("<h1 style='text-align:center;'>üëü DENE Store ‚Äî –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h1>", unsafe_allow_html=True)

# === –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ç–∞–ª–æ–≥–∞ ===
@st.cache_data(show_spinner=False)
def load_data():
    if not os.path.exists(CATALOG_PATH):
        st.error("‚ùå –§–∞–π–ª –∫–∞—Ç–∞–ª–æ–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        return pd.DataFrame()

    df = pd.read_excel(CATALOG_PATH)
    df = df.fillna("")

    # –†–∞–∑–±–æ—Ä –º–æ–¥–µ–ª–∏ –∏ —Ä–∞–∑–º–µ—Ä–∞
    df["model_clean"] = df["model"].str.replace(r"\d{1,2}(\.\d)?", "", regex=True).str.strip()
    df["size"] = df["model"].str.extract(r"(\d{1,2}(\.\d)?)")[0]
    df["gender"] = df["model"].apply(lambda x: "men" if "men" in x.lower() else ("women" if "women" in x.lower() else "unisex"))
    df["color"] = df["model"].str.extract(r"(white|black|blue|red|green|pink|gray|brown)", expand=False).fillna("other")

    if "description" not in df.columns:
        df["description"] = "–û–ø–∏—Å–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ."

    return df

df = load_data()

# === –§–∏–ª—å—Ç—Ä—ã ===
st.divider()
st.markdown("### üîé –§–∏–ª—å—Ç—Ä –∫–∞—Ç–∞–ª–æ–≥–∞")

col1, col2, col3, col4, col5 = st.columns(5)
brand_filter = col1.selectbox("–ë—Ä–µ–Ω–¥", ["–í—Å–µ"] + sorted(df["brand"].unique().tolist()))
filtered_df = df if brand_filter == "–í—Å–µ" else df[df["brand"] == brand_filter]

models = sorted(filtered_df["model_clean"].unique().tolist())
model_filter = col2.selectbox("–ú–æ–¥–µ–ª—å", ["–í—Å–µ"] + models)
size_filter = col3.selectbox("–†–∞–∑–º–µ—Ä", ["–í—Å–µ"] + sorted(df["size"].dropna().unique().tolist()))
gender_filter = col4.selectbox("–ü–æ–ª", ["–í—Å–µ", "men", "women", "unisex"])
color_filter = col5.selectbox("–¶–≤–µ—Ç", ["–í—Å–µ"] + sorted(df["color"].dropna().unique().tolist()))

filtered_df = df.copy()
if brand_filter != "–í—Å–µ":
    filtered_df = filtered_df[filtered_df["brand"] == brand_filter]
if model_filter != "–í—Å–µ":
    filtered_df = filtered_df[filtered_df["model_clean"] == model_filter]
if size_filter != "–í—Å–µ":
    filtered_df = filtered_df[filtered_df["size"] == size_filter]
if gender_filter != "–í—Å–µ":
    filtered_df = filtered_df[filtered_df["gender"] == gender_filter]
if color_filter != "–í—Å–µ":
    filtered_df = filtered_df[filtered_df["color"] == color_filter]

st.divider()
st.markdown("## üì¶ –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤")

# === –§—É–Ω–∫—Ü–∏—è –ø–æ–∏—Å–∫–∞ —Ñ–æ—Ç–æ ===
def find_image(brand, model, sku):
    """
    –ò—â–µ—Ç —Ñ–æ—Ç–æ –ø–æ –ø—É—Ç–∏ data/images/<brand>/<model>/<sku>*.jpg
    –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç no_image.jpg
    """
    brand_path = os.path.join("data", "images", brand)
    model_path = os.path.join(brand_path, model)
    search_pattern = os.path.join(model_path, f"{sku}*.jpg")
    matches = glob.glob(search_pattern)
    return matches[0] if matches else NO_IMAGE_PATH

# === –°–µ—Ç–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ ===
num_cols = 4
rows = [filtered_df.iloc[i:i + num_cols] for i in range(0, len(filtered_df), num_cols)]

for row_df in rows:
    cols = st.columns(num_cols)
    for col, (_, row) in zip(cols, row_df.iterrows()):
        brand = str(row["brand"]).strip()
        model = str(row["model_clean"]).strip()
        sku = str(row["SKU"]).strip()
        price = str(row["price"]).strip()

        if not brand or not sku:
            continue  # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏

        image_path = find_image(brand, model, sku)

        # –¶–µ–Ω–∞ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ
        price_html = f"<p style='font-weight:bold; font-size:16px; margin-top:6px;'>{int(price)} ‚Ç∏</p>" if price.isdigit() else ""
        desc_html = f"<p style='font-size:13px; color:#555;'>{row['description']}</p>"

        col.markdown(f"""
        <div style="
            border:1px solid #eee;
            border-radius:16px;
            padding:12px;
            margin-bottom:16px;
            background-color:#fff;
            box-shadow:0 2px 10px rgba(0,0,0,0.05);
            transition:transform 0.2s ease-in-out;
        " onmouseover="this.style.transform='scale(1.02)';"
          onmouseout="this.style.transform='scale(1)';">
            <img src='{image_path}' style='width:100%; border-radius:12px; object-fit:cover; height:220px;'>
            <h4 style="margin:10px 0 4px 0;">{brand} {model}</h4>
            {desc_html}
            {price_html}
        </div>
        """, unsafe_allow_html=True)

st.divider()
st.caption("¬© 2025 DENE Store")
