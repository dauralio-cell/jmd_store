import streamlit as st
import pandas as pd
import glob
import os
import re
from PIL import Image

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ---
st.set_page_config(
    page_title="DENE Store", 
    layout="wide",
    initial_sidebar_state="collapsed"
)

# --- CSS —Å—Ç–∏–ª–∏ ---
st.markdown("""
<style>
    /* –û—Å–Ω–æ–≤–Ω—ã–µ —Å—Ç–∏–ª–∏ */
    .main {
        background-color: #ffffff;
    }
    
    /* –•–µ–¥–µ—Ä */
    .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 2rem 0;
        margin-bottom: 2rem;
        border-radius: 0 0 15px 15px;
    }
    
    /* –ö–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ - –§–ò–ö–°–ò–†–û–í–ê–ù–ù–´–ï */
    .product-card {
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 20px;
        background: white;
        transition: all 0.3s ease;
        height: auto;
        min-height: 400px;
        display: flex;
        flex-direction: column;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .product-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        border-color: #667eea;
    }
    
    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è */
    .image-container {
        height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 12px;
        background: #f8f9fa;
        border-radius: 8px;
        overflow: hidden;
    }
    
    /* –ö–Ω–æ–ø–∫–∏ */
    .stButton button {
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
        border: none;
    }
    
    .primary-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
        color: white !important;
    }
    
    .secondary-btn {
        background: #f8f9fa !important;
        color: #333 !important;
        border: 1px solid #dee2e6 !important;
    }
    
    /* –¶–µ–Ω—ã */
    .price {
        font-size: 1.25rem;
        font-weight: bold;
        color: #2c5530;
        margin: 8px 0;
    }
    
    /* –¢–µ–∫—Å—Ç */
    .product-brand {
        font-weight: bold;
        font-size: 1.1rem;
        margin-bottom: 4px;
        color: #333;
    }
    
    .product-model {
        font-weight: 600;
        font-size: 1rem;
        margin-bottom: 4px;
        color: #555;
    }
    
    .product-color {
        color: #666;
        font-style: italic;
        margin-bottom: 8px;
    }
    
    .sizes {
        color: #888;
        font-size: 0.9rem;
        margin-bottom: 12px;
    }
    
    /* –§–∏–ª—å—Ç—Ä—ã */
    .filter-section {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 2rem;
        border: 1px solid #e9ecef;
    }
</style>
""", unsafe_allow_html=True)

# --- –û–±–ª–æ–∂–∫–∞ ---
st.markdown("""
<div class="header">
    <div style="text-align:center; color:white;">
        <h1 style="margin:0; font-size:2.5rem;">DENE STORE</h1>
        <p style="margin:0; opacity:0.9; font-size:1.2rem;">–ü—Ä–µ–º–∏–∞–ª—å–Ω—ã–µ –∫—Ä–æ—Å—Å–æ–≤–∫–∏ –∏ —Å–ø–æ—Ä—Ç–∏–≤–Ω–∞—è –æ–±—É–≤—å</p>
    </div>
</div>
""", unsafe_allow_html=True)

# --- –ü—É—Ç–∏ ---
CATALOG_PATH = "data/catalog.xlsx"
IMAGES_PATH = "data/images"

# --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Å—Å–∏–∏ ---
if 'cart' not in st.session_state:
    st.session_state.cart = []
if 'selected_product' not in st.session_state:
    st.session_state.selected_product = None
if 'current_tab' not in st.session_state:
    st.session_state.current_tab = "–ö–∞—Ç–∞–ª–æ–≥"

# --- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–∞–±—ã ---
tabs = st.columns(5)
with tabs[0]:
    if st.button("üè† –ì–ª–∞–≤–Ω–∞—è", use_container_width=True, type="primary" if st.session_state.current_tab == "–ì–ª–∞–≤–Ω–∞—è" else "secondary"):
        st.session_state.current_tab = "–ì–ª–∞–≤–Ω–∞—è"
        st.rerun()
with tabs[1]:
    if st.button("üëü –ö–∞—Ç–∞–ª–æ–≥", use_container_width=True, type="primary" if st.session_state.current_tab == "–ö–∞—Ç–∞–ª–æ–≥" else "secondary"):
        st.session_state.current_tab = "–ö–∞—Ç–∞–ª–æ–≥"
        st.rerun()
with tabs[2]:
    if st.button("üî• –ù–æ–≤–∏–Ω–∫–∏", use_container_width=True, type="primary" if st.session_state.current_tab == "–ù–æ–≤–∏–Ω–∫–∏" else "secondary"):
        st.session_state.current_tab = "–ù–æ–≤–∏–Ω–∫–∏"
        st.rerun()
with tabs[3]:
    if st.button("üè∑Ô∏è –ê–∫—Ü–∏–∏", use_container_width=True, type="primary" if st.session_state.current_tab == "–ê–∫—Ü–∏–∏" else "secondary"):
        st.session_state.current_tab = "–ê–∫—Ü–∏–∏"
        st.rerun()
with tabs[4]:
    cart_count = len(st.session_state.cart)
    badge_text = f"üõí –ö–æ—Ä–∑–∏–Ω–∞ ({cart_count})" if cart_count > 0 else "üõí –ö–æ—Ä–∑–∏–Ω–∞"
    if st.button(badge_text, use_container_width=True, type="primary" if st.session_state.current_tab == "–ö–æ—Ä–∑–∏–Ω–∞" else "secondary"):
        st.session_state.current_tab = "–ö–æ—Ä–∑–∏–Ω–∞"
        st.rerun()

st.markdown("---")

# --- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö ---
@st.cache_data(ttl=300)
def load_data():
    try:
        if not os.path.exists(CATALOG_PATH):
            st.error("–§–∞–π–ª –∫–∞—Ç–∞–ª–æ–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return pd.DataFrame()
        
        df_nike = pd.read_excel(CATALOG_PATH, sheet_name='Nike')
        df_mizuno = pd.read_excel(CATALOG_PATH, sheet_name='Mizuno')
        
        df = pd.concat([df_nike, df_mizuno], ignore_index=True)
        
        # –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π
        columns_to_fill = ['brand', 'model', 'color', 'gender', 'image']
        for col in columns_to_fill:
            if col in df.columns:
                df[col] = df[col].fillna(method='ffill').fillna('')
        
        # –û—á–∏—Å—Ç–∫–∞ –Ω–∞–∑–≤–∞–Ω–∏–π –º–æ–¥–µ–ª–µ–π
        df["model_clean"] = df["model"].apply(lambda x: re.sub(r'\([^)]*\)', '', str(x))).str.strip()
        
        # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤
        size_columns = ['size US', 'size EU', 'size_US', 'size_EU']
        for size_col in size_columns:
            if size_col in df.columns:
                if 'US' in size_col:
                    df["size_us"] = df[size_col].fillna("").astype(str).str.strip()
                elif 'EU' in size_col:
                    df["size_eu"] = df[size_col].fillna("").astype(str).str.strip()
        
        if 'size_us' not in df.columns:
            df['size_us'] = ''
        if 'size_eu' not in df.columns:
            df['size_eu'] = ''
        
        # –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –≤–∞–ª–∏–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        df = df[
            (df['brand'].notna()) & (df['brand'] != '') &
            (df['model_clean'].notna()) & (df['model_clean'] != '')
        ]
        
        return df
        
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: {e}")
        return pd.DataFrame()

# --- –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ---
def get_image_paths(image_names, sku):
    image_paths = []
    
    if pd.notna(image_names) and image_names != "":
        for image_name in str(image_names).split():
            patterns = [
                os.path.join(IMAGES_PATH, "**", f"{image_name}.*"),
                os.path.join(IMAGES_PATH, "**", f"{image_name}.jpg"),
            ]
            for pattern in patterns:
                found = glob.glob(pattern, recursive=True)
                if found:
                    image_paths.extend(found)
                    break
    
    if pd.notna(sku) and sku != "":
        patterns = [
            os.path.join(IMAGES_PATH, "**", f"{sku}_*.jpg"),
            os.path.join(IMAGES_PATH, "**", f"{sku}_*.webp"),
        ]
        for pattern in patterns:
            found = glob.glob(pattern, recursive=True)
            if found:
                for img in found:
                    if img not in image_paths:
                        image_paths.append(img)
    
    return list(dict.fromkeys(image_paths))

def display_product_image(image_paths, key_suffix=""):
    """–£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞"""
    if not image_paths:
        st.markdown("""
            <div class="image-container">
                <div style="text-align: center; color: #999;">
                    <div style="font-size: 48px;">üëü</div>
                    <div>–ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
                </div>
            </div>
        """, unsafe_allow_html=True)
        return None
    
    if f"selected_{key_suffix}" not in st.session_state:
        st.session_state[f"selected_{key_suffix}"] = 0
    
    selected_index = st.session_state[f"selected_{key_suffix}"]
    
    try:
        img = Image.open(image_paths[selected_index])
        # –†–µ—Å–∞–π–∑–∏–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è
        img.thumbnail((300, 200))
        st.image(img, use_container_width=True)
        return True
    except Exception as e:
        st.markdown("""
            <div class="image-container">
                <div style="text-align: center; color: #999;">
                    <div style="font-size: 48px;">‚ùå</div>
                    <div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>
                </div>
            </div>
        """, unsafe_allow_html=True)
        return False

# --- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ ---
def group_products(df):
    if df.empty:
        return pd.DataFrame()
    
    df_clean = df[
        (df['brand'].notna()) & (df['brand'] != '') &
        (df['model_clean'].notna()) & (df['model_clean'] != '') &
        (df['color'].notna()) & (df['color'] != '')
    ].copy()
    
    if df_clean.empty:
        return pd.DataFrame()
    
    grouped = df_clean.groupby(['brand', 'model_clean', 'color']).agg({
        'sku': 'first',
        'image': 'first', 
        'gender': 'first',
        'price': 'first',
        'size_us': lambda x: [str(s) for s in x if s and str(s).strip() != ""],
        'size_eu': lambda x: [str(s) for s in x if s and str(s).strip() != ""]
    }).reset_index()
    
    return grouped

def get_other_colors(df, brand, model_clean, current_color):
    variants = df[
        (df['brand'] == brand) & 
        (df['model_clean'] == model_clean) &
        (df['color'] != current_color)
    ].drop_duplicates('color')
    return variants

# --- –ö–æ—Ä–∑–∏–Ω–∞ ---
def add_to_cart(item):
    st.session_state.cart.append(item)
    st.success(f"‚úÖ {item['brand']} {item['model']} –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É")

def display_cart_page():
    st.markdown("## üõí –ö–æ—Ä–∑–∏–Ω–∞ –ø–æ–∫—É–ø–æ–∫")
    
    if not st.session_state.cart:
        st.info("""
        ### –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞
        –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –∫–∞—Ç–∞–ª–æ–≥, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä—ã
        """)
        if st.button("–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∫–∞—Ç–∞–ª–æ–≥"):
            st.session_state.current_tab = "–ö–∞—Ç–∞–ª–æ–≥"
            st.rerun()
        return
    
    total = 0
    for i, item in enumerate(st.session_state.cart):
        with st.container():
            col1, col2, col3, col4 = st.columns([3, 1, 1, 1])
            with col1:
                st.markdown(f"**{item['brand']} {item['model']}**")
                st.markdown(f"–¶–≤–µ—Ç: {item['color']} | –†–∞–∑–º–µ—Ä: {item['size_us']}US")
            with col2:
                st.markdown(f"**{item['price']} ‚Ç∏**")
            with col3:
                st.markdown("–ö–æ–ª-–≤–æ: 1")
            with col4:
                if st.button("üóëÔ∏è –£–¥–∞–ª–∏—Ç—å", key=f"remove_{i}"):
                    st.session_state.cart.pop(i)
                    st.rerun()
        
        total += float(item['price']) if item['price'] and str(item['price']).strip() else 0
    
    st.markdown("---")
    col1, col2 = st.columns(2)
    with col1:
        st.markdown(f"### –ò—Ç–æ–≥–æ: {total:,.0f} ‚Ç∏")
    with col2:
        if st.button("üì¶ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑", type="primary", use_container_width=True):
            st.success("üéâ –ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω! –° –≤–∞–º–∏ —Å–≤—è–∂—É—Ç—Å—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.")
            st.session_state.cart = []
    
    if st.button("üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É", type="secondary"):
        st.session_state.cart = []
        st.rerun()

# --- –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–æ–≤–∞—Ä–∞ ---
def show_product_details(product, other_colors, df):
    st.markdown("### –î–µ—Ç–∞–ª–∏ —Ç–æ–≤–∞—Ä–∞")
    
    if st.button("‚Üê –ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–∞–ª–æ–≥—É"):
        st.session_state.selected_product = None
        st.rerun()
    
    col1, col2 = st.columns([2, 1])
    
    with col1:
        image_paths = get_image_paths(product['image'], product['sku'])
        display_product_image(image_paths, key_suffix=f"detail_{product['sku']}")
    
    with col2:
        st.markdown(f"## {product['brand']} {product['model_clean']}")
        st.markdown(f"**–¶–≤–µ—Ç:** {product['color']}")
        st.markdown(f"**–ü–æ–ª:** {product['gender']}")
        
        # –†–∞–∑–º–µ—Ä—ã
        us_sizes = product['size_us']
        eu_sizes = product['size_eu']
        
        if us_sizes:
            selected_size = st.selectbox("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ä (US):", us_sizes)
        else:
            selected_size = "–ù–µ —É–∫–∞–∑–∞–Ω"
            st.warning("–†–∞–∑–º–µ—Ä—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã")
        
        # –¶–µ–Ω–∞
        price = product['price']
        if price and str(price).strip() and str(price) != 'nan':
            st.markdown(f'<div class="price">{price} ‚Ç∏</div>', unsafe_allow_html=True)
        else:
            st.markdown('<div class="price">–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞</div>', unsafe_allow_html=True)
        
        # –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É
        if st.button("üõí –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É", use_container_width=True, type="primary"):
            add_to_cart({
                'brand': product['brand'],
                'model': product['model_clean'],
                'color': product['color'],
                'size_us': selected_size,
                'price': price if price and str(price).strip() else "0"
            })
    
    # –î—Ä—É–≥–∏–µ —Ü–≤–µ—Ç–∞
    if not other_colors.empty:
        st.markdown("---")
        st.markdown("### –î—Ä—É–≥–∏–µ —Ü–≤–µ—Ç–∞")
        
        cols = st.columns(min(len(other_colors), 4))
        
        for idx, (_, variant) in enumerate(other_colors.iterrows()):
            with cols[idx]:
                with st.container():
                    st.markdown('<div class="product-card">', unsafe_allow_html=True)
                    
                    variant_images = get_image_paths(variant['image'], variant['sku'])
                    display_product_image(variant_images, key_suffix=f"variant_{variant['sku']}")
                    
                    st.markdown(f'<div class="product-color">{variant["color"]}</div>', unsafe_allow_html=True)
                    
                    variant_price = variant['price']
                    if variant_price and str(variant_price).strip():
                        st.markdown(f'<div class="price">{variant_price} ‚Ç∏</div>', unsafe_allow_html=True)
                    
                    if st.button("–í—ã–±—Ä–∞—Ç—å", key=f"select_{variant['sku']}", use_container_width=True):
                        new_other_colors = get_other_colors(df, variant['brand'], variant['model_clean'], variant['color'])
                        st.session_state.selected_product = {
                            'product': variant,
                            'other_colors': new_other_colors
                        }
                        st.rerun()
                    
                    st.markdown('</div>', unsafe_allow_html=True)

# --- –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ---
def show_home_page():
    st.markdown("""
    ## üè† –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ DENE Store!
    
    ### –õ—É—á—à–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –Ω–µ–¥–µ–ª–∏
    """)
    
    # –ü—Ä–æ–º–æ-–±–ª–æ–∫–∏
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.markdown("""
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 12px; text-align: center;">
            <h3>üöÄ –ù–æ–≤–∏–Ω–∫–∏</h3>
            <p>–°–∞–º—ã–µ —Å–≤–µ–∂–∏–µ –º–æ–¥–µ–ª–∏ —Å–µ–∑–æ–Ω–∞</p>
        </div>
        """, unsafe_allow_html=True)
    
    with col2:
        st.markdown("""
        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 2rem; border-radius: 12px; text-align: center;">
            <h3>üî• –†–∞—Å–ø—Ä–æ–¥–∞–∂–∞</h3>
            <p>–°–∫–∏–¥–∫–∏ –¥–æ 50%</p>
        </div>
        """, unsafe_allow_html=True)
    
    with col3:
        st.markdown("""
        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 2rem; border-radius: 12px; text-align: center;">
            <h3>‚≠ê –ë–µ—Å—Ç—Å–µ–ª–ª–µ—Ä—ã</h3>
            <p>–°–∞–º—ã–µ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –º–æ–¥–µ–ª–∏</p>
        </div>
        """, unsafe_allow_html=True)

# --- –£–ª—É—á—à–µ–Ω–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞ ---
def display_product_card(product, df, col_idx, row_idx):
    """–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞ –±–µ–∑ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤"""
    
    with st.container():
        # –ò—Å–ø–æ–ª—å–∑—É–µ–º —á–∏—Å—Ç—ã–π HTML –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–º–µ—Å—Ç–æ —Å–ª–æ–∂–Ω—ã—Ö CSS
        st.markdown("""
        <div style='
            border: 1px solid #e0e0e0; 
            border-radius: 12px; 
            padding: 16px; 
            margin-bottom: 20px; 
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            height: auto;
        '>
        """, unsafe_allow_html=True)
        
        # –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
        image_paths = get_image_paths(product['image'], product['sku'])
        display_product_image(image_paths, key_suffix=f"card_{product['sku']}_{row_idx}_{col_idx}")
        
        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ
        st.markdown(f"<div class='product-brand'>{product['brand']}</div>", unsafe_allow_html=True)
        st.markdown(f"<div class='product-model'>{product['model_clean']}</div>", unsafe_allow_html=True)
        st.markdown(f"<div class='product-color'>{product['color']}</div>", unsafe_allow_html=True)
        
        # –†–∞–∑–º–µ—Ä—ã
        us_sizes = product['size_us']
        if us_sizes:
            sizes_display = ', '.join(us_sizes[:3]) + ('...' if len(us_sizes) > 3 else '')
            st.markdown(f"<div class='sizes'>–†–∞–∑–º–µ—Ä—ã US: {sizes_display}</div>", unsafe_allow_html=True)
        
        # –¶–µ–Ω–∞
        price = product['price']
        if price and str(price).strip() and str(price) != 'nan':
            st.markdown(f"<div class='price'>{price} ‚Ç∏</div>", unsafe_allow_html=True)
        else:
            st.markdown("<div style='color: #999; margin: 8px 0;'>–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞</div>", unsafe_allow_html=True)
        
        # –ö–Ω–æ–ø–∫–∏
        col_btn1, col_btn2 = st.columns(2)
        with col_btn1:
            if st.button("üëÄ –ü–æ–¥—Ä–æ–±–Ω–µ–µ", key=f"view_{product['sku']}_{row_idx}_{col_idx}", 
                       use_container_width=True, type="secondary"):
                other_colors = get_other_colors(df, product['brand'], product['model_clean'], product['color'])
                st.session_state.selected_product = {
                    'product': product,
                    'other_colors': other_colors
                }
                st.rerun()
        
        with col_btn2:
            if st.button("üõí –ö—É–ø–∏—Ç—å", key=f"buy_{product['sku']}_{row_idx}_{col_idx}", 
                       use_container_width=True, type="primary"):
                add_to_cart({
                    'brand': product['brand'],
                    'model': product['model_clean'],
                    'color': product['color'],
                    'size_us': us_sizes[0] if us_sizes else "",
                    'price': price if price and str(price).strip() else "0"
                })
        
        st.markdown("</div>", unsafe_allow_html=True)

# --- –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤ ---
def show_catalog_page():
    st.markdown("## üëü –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤")
    
    # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
    with st.spinner('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ç–∞–ª–æ–≥–∞...'):
        df = load_data()
    
    if df.empty:
        st.error("–ö–∞—Ç–∞–ª–æ–≥ –ø—É—Å—Ç –∏–ª–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω")
        return
    
    # –§–∏–ª—å—Ç—Ä—ã
    with st.container():
        st.markdown('<div class="filter-section">', unsafe_allow_html=True)
        st.markdown("### üîç –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä—ã")
        
        col1, col2, col3, col4 = st.columns(4)
        
        with col1:
            brands = ["–í—Å–µ –±—Ä–µ–Ω–¥—ã"] + sorted(df['brand'].unique().tolist())
            brand_filter = st.selectbox("–ë—Ä–µ–Ω–¥", brands)
        
        with col2:
            if brand_filter != "–í—Å–µ –±—Ä–µ–Ω–¥—ã":
                brand_models = sorted(df[df["brand"] == brand_filter]["model_clean"].unique().tolist())
            else:
                brand_models = sorted(df["model_clean"].unique().tolist())
            model_filter = st.selectbox("–ú–æ–¥–µ–ª—å", ["–í—Å–µ –º–æ–¥–µ–ª–∏"] + brand_models)
        
        with col3:
            sizes_us = ["–í—Å–µ —Ä–∞–∑–º–µ—Ä—ã"] + sorted([s for s in df['size_us'].unique() if s])
            size_us_filter = st.selectbox("–†–∞–∑–º–µ—Ä US", sizes_us)
        
        with col4:
            colors = ["–í—Å–µ —Ü–≤–µ—Ç–∞"] + sorted(df['color'].unique().tolist())
            color_filter = st.selectbox("–¶–≤–µ—Ç", colors)
        
        search_query = st.text_input("–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é...", placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ –∏–ª–∏ –±—Ä–µ–Ω–¥–∞")
        
        st.markdown('</div>', unsafe_allow_html=True)
    
    # –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
    filtered_df = df.copy()
    if brand_filter != "–í—Å–µ –±—Ä–µ–Ω–¥—ã":
        filtered_df = filtered_df[filtered_df['brand'] == brand_filter]
    if model_filter != "–í—Å–µ –º–æ–¥–µ–ª–∏":
        filtered_df = filtered_df[filtered_df['model_clean'] == model_filter]
    if size_us_filter != "–í—Å–µ —Ä–∞–∑–º–µ—Ä—ã":
        filtered_df = filtered_df[filtered_df['size_us'] == size_us_filter]
    if color_filter != "–í—Å–µ —Ü–≤–µ—Ç–∞":
        filtered_df = filtered_df[filtered_df['color'] == color_filter]
    if search_query:
        filtered_df = filtered_df[
            filtered_df["model_clean"].str.contains(search_query, case=False, na=False) |
            filtered_df["brand"].str.contains(search_query, case=False, na=False)
        ]
    
    # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —Ç–æ–≤–∞—Ä—ã
    grouped_products = group_products(filtered_df)
    
    if grouped_products.empty:
        st.warning("üòî –¢–æ–≤–∞—Ä—ã –ø–æ –∑–∞–¥–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.")
        st.info("–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏")
    else:
        st.markdown(f"### –ù–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: {len(grouped_products)}")
        
        # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ –≤ —Å–µ—Ç–∫–µ 4 –∫–æ–ª–æ–Ω–∫–∏
        num_cols = 4
        rows = [grouped_products.iloc[i:i+num_cols] for i in range(0, len(grouped_products), num_cols)]
        
        for row_idx, row_df in enumerate(rows):
            cols = st.columns(num_cols)
            for col_idx, (_, product) in zip(cols, row_df.iterrows()):
                with col_idx:
                    display_product_card(product, df, col_idx, row_idx)

# --- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---
def main():
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –µ—Å–ª–∏ —Ç–æ–≤–∞—Ä –≤—ã–±—Ä–∞–Ω
    if st.session_state.selected_product is not None:
        show_product_details(
            st.session_state.selected_product['product'], 
            st.session_state.selected_product['other_colors'],
            load_data()
        )
    else:
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ —Ç–∞–±—É
        if st.session_state.current_tab == "–ì–ª–∞–≤–Ω–∞—è":
            show_home_page()
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á–∞—Å—Ç—å –∫–∞—Ç–∞–ª–æ–≥–∞ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π
            st.markdown("---")
            st.markdown("## üéØ –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã")
            show_catalog_page()
        elif st.session_state.current_tab == "–ö–∞—Ç–∞–ª–æ–≥":
            show_catalog_page()
        elif st.session_state.current_tab == "–ù–æ–≤–∏–Ω–∫–∏":
            st.markdown("## üî• –ù–æ–≤–∏–Ω–∫–∏")
            show_catalog_page()
        elif st.session_state.current_tab == "–ê–∫—Ü–∏–∏":
            st.markdown("## üè∑Ô∏è –ê–∫—Ü–∏–∏ –∏ —Å–∫–∏–¥–∫–∏")
            st.info("–°–∫–æ—Ä–æ –ø–æ—è–≤—è—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è!")
            show_catalog_page()
        elif st.session_state.current_tab == "–ö–æ—Ä–∑–∏–Ω–∞":
            display_cart_page()
    
    # –§—É—Ç–µ—Ä
    st.markdown("---")
    st.markdown("""
    <div style="text-align: center; color: #666; padding: 2rem;">
        <p>¬© 2025 DENE Store. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
    </div>
    """, unsafe_allow_html=True)

if __name__ == "__main__":
    main()