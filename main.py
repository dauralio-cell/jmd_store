import streamlit as st
import pandas as pd
import os
import glob
from PIL import Image

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ---
st.set_page_config(page_title="JMD Store", layout="wide")

# --- –ü—É—Ç–∏ ---
DATA_DIR = "jmd_store/data"
IMG_DIR = os.path.join(DATA_DIR, "images")
CATALOG_PATH = os.path.join(DATA_DIR, "catalog.xlsx")
BANNER_PATH = os.path.join(IMG_DIR, "banner.jpg")

# --- –û–±–ª–æ–∂–∫–∞ ---
if os.path.exists(BANNER_PATH):
    st.image(BANNER_PATH, use_container_width=True)
else:
    st.warning(f"‚ùå –ë–∞–Ω–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω: {BANNER_PATH}")

st.markdown("<h1 style='text-align:center; font-size:40px;'>JMD Store</h1>", unsafe_allow_html=True)

# --- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–∞ –∫–∞—Ç–∞–ª–æ–≥–∞ ---
if not os.path.exists(CATALOG_PATH):
    st.error(f"‚ùå –§–∞–π–ª –∫–∞—Ç–∞–ª–æ–≥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω: {CATALOG_PATH}")
    st.stop()

# --- –ß—Ç–µ–Ω–∏–µ Excel (–≤—Å–µ –ª–∏—Å—Ç—ã) ---
xls = pd.ExcelFile(CATALOG_PATH)
dfs = []
for sheet in xls.sheet_names:
    df = pd.read_excel(xls, sheet_name=sheet)
    df["brand"] = sheet  # –ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω–æ –≤ –¥–∞–Ω–Ω—ã—Ö
    dfs.append(df)
data = pd.concat(dfs, ignore_index=True)

# --- –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö ---
data = data.fillna("")
data = data[data["model"] != ""]

# --- –§–∏–ª—å—Ç—Ä—ã ---
brands = sorted(data["brand"].unique())
models = sorted(data["model"].unique())
genders = sorted(data["gender"].unique())
colors = sorted(data["color"].unique())

col1, col2, col3, col4 = st.columns(4)
brand_filter = col1.multiselect("–ë—Ä–µ–Ω–¥", brands)
model_filter = col2.multiselect("–ú–æ–¥–µ–ª—å", models)
gender_filter = col3.multiselect("–ü–æ–ª", genders)
color_filter = col4.multiselect("–¶–≤–µ—Ç", colors)

filtered = data.copy()
if brand_filter:
    filtered = filtered[filtered["brand"].isin(brand_filter)]
if model_filter:
    filtered = filtered[filtered["model"].isin(model_filter)]
if gender_filter:
    filtered = filtered[filtered["gender"].isin(gender_filter)]
if color_filter:
    filtered = filtered[filtered["color"].isin(color_filter)]

# --- –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –º–æ–¥–µ–ª–∏ –∏ —Ü–≤–µ—Ç—É ---
grouped = filtered.groupby(["brand", "model", "color"], dropna=False)

# --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π ---
def find_image_paths(image_names):
    found = []
    for name in str(image_names).split():
        pattern = os.path.join(IMG_DIR, "**", f"{name}.*")
        matches = glob.glob(pattern, recursive=True)
        if matches:
            found.extend(matches)
    return found

# --- –°–µ—Ç–∫–∞ –∫–∞—Ä—Ç–æ—á–µ–∫ ---
for (brand, model, color), group in grouped:
    sku = group["sku"].iloc[0]
    images = find_image_paths(group["image"].iloc[0])
    sizes_us = [str(s) for s in group["size US"] if s]
    sizes_eu = [str(s) for s in group["size EU"] if s]
    price = group["price"].iloc[0]
    desc = group["description"].iloc[0]
    in_stock = group["in stock"].iloc[0]
    preorder = group["preorder"].iloc[0]

    if images:
        main_img = images[0]
    else:
        main_img = os.path.join(IMG_DIR, "no_image.jpg")

    col = st.container()
    with col:
        c1, c2 = st.columns([1, 3])
        with c1:
            try:
                st.image(main_img, use_container_width=True)
            except:
                st.warning("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è")
        with c2:
            st.markdown(f"### {brand} ‚Äî {model}")
            st.write(f"**–¶–≤–µ—Ç:** {color}")
            st.write(f"**–¶–µ–Ω–∞:** {price} ‚Ç∏")
            if in_stock.lower() == "yes":
                st.success("‚úÖ –í –Ω–∞–ª–∏—á–∏–∏")
            elif preorder.lower() == "yes":
                st.info("üïì –ü—Ä–µ–¥–∑–∞–∫–∞–∑")
            else:
                st.error("‚ùå –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏")

            if st.button(f"–ü–æ–¥—Ä–æ–±–Ω–µ–µ ‚Äî {brand} {model} ({color})"):
                with st.expander(f"–ü–æ–¥—Ä–æ–±–Ω–µ–µ –æ {brand} {model} ({color})", expanded=True):
                    if len(images) > 1:
                        cols = st.columns(min(len(images), 5))
                        for i, img in enumerate(images[:5]):
                            with cols[i]:
                                st.image(img, use_container_width=True)
                    st.write(f"**–†–∞–∑–º–µ—Ä—ã (US):** {', '.join(sizes_us)}")
                    st.write(f"**–†–∞–∑–º–µ—Ä—ã (EU):** {', '.join(sizes_eu)}")
                    st.write(f"**–û–ø–∏—Å–∞–Ω–∏–µ:** {desc if desc else '‚Äî'}")

    st.divider()
