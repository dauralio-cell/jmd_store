# main.py
import streamlit as st
import pandas as pd
import os
import glob
from PIL import Image

# ----------------------
# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
# ----------------------
st.set_page_config(page_title="JMD Store", layout="wide")
DATA_DIR = "data"
IMAGE_DIR = os.path.join(DATA_DIR, "images")
CATALOG_PATH = os.path.join(DATA_DIR, "catalog.xlsx")
PLACEHOLDER = os.path.join(IMAGE_DIR, "no_image.jpg") if os.path.exists(os.path.join(IMAGE_DIR, "no_image.jpg")) else None

# ----------------------
# –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
# ----------------------
def scan_images(image_dir):
    """–°–∫–∞–Ω–∏—Ä—É–µ–º –≤—Å–µ —Ñ–∞–π–ª—ã –∫–∞—Ä—Ç–∏–Ω–æ–∫ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º dict: base_name_lower -> full_path"""
    patterns = ["*.jpg", "*.jpeg", "*.png", "*.webp", "*.gif"]
    files = []
    for pat in patterns:
        files.extend(glob.glob(os.path.join(image_dir, "**", pat), recursive=True))
    image_map = {}
    for p in files:
        key = os.path.splitext(os.path.basename(p))[0].strip().lower()
        # –µ—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–∞–π–ª–æ–≤ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –∏–º–µ–Ω–µ–º ‚Äî –æ—Å—Ç–∞–≤–∏–º –ø–µ—Ä–≤—ã–π –≤—Å—Ç—Ä–µ—Ç–∏–≤—à–∏–π—Å—è
        if key not in image_map:
            image_map[key] = p
    return image_map

def first_existing_image(names_str, image_map):
    """names_str - —Å—Ç—Ä–æ–∫–∞ —Ç–∏–ø–∞ '100001_1 100001_2' -> –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ø–∏—Å–æ–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –ø—É—Ç–µ–π (–≤ –ø–æ—Ä—è–¥–∫–µ)"""
    if not names_str or str(names_str).strip() == "":
        return []
    out = []
    for nm in str(names_str).split():
        key = nm.strip().lower()
        if key in image_map:
            out.append(image_map[key])
    return out

def normalize_and_forward_fill(df):
    """–ó–∞–ø–æ–ª–Ω—è–µ–º –ø—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –ø—Ä–µ–¥—ã–¥—É—â–∏–º–∏ –∑–Ω–∞—á–µ–Ω–∏—è–º–∏ –¥–ª—è –Ω—É–∂–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤"""
    cols_to_ffill = ["brand", "model", "gender", "color", "image", "price", "preorder", "in stock", "description"]
    # —É–±–µ–¥–∏–º—Å—è —á—Ç–æ –≤—Å–µ –∫–æ–ª–æ–Ω–∫–∏ –µ—Å—Ç—å
    for col in cols_to_ffill:
        if col not in df.columns:
            df[col] = ""
    # iterate rows and forward-fill by last seen
    last = {c: "" for c in cols_to_ffill}
    rows = []
    for _, r in df.iterrows():
        r = r.fillna("")  # ensure no NaN
        new = r.to_dict()
        for c in cols_to_ffill:
            val = str(new.get(c, "")).strip()
            if val == "":
                new[c] = last[c]
            else:
                new[c] = val
                last[c] = val
        rows.append(new)
    new_df = pd.DataFrame(rows)
    return new_df

# ----------------------
# –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
# ----------------------
if not os.path.exists(CATALOG_PATH):
    st.error(f"–ù–µ –Ω–∞–π–¥–µ–Ω —Ñ–∞–π–ª {CATALOG_PATH}")
    st.stop()

# Load all sheets (each sheet -> brand)
xls = pd.ExcelFile(CATALOG_PATH)
dfs = []
for sheet_name in xls.sheet_names:
    sheet_df = pd.read_excel(xls, sheet_name=sheet_name, dtype=str)
    # –ï—Å–ª–∏ –≤ –ª–∏—Å—Ç–µ –Ω–µ—Ç –∫–æ–ª–æ–Ω–∫–∏ brand, –ø—Ä–æ—Å—Ç–∞–≤–∏–º –∏–º—è –ª–∏—Å—Ç–∞
    if "brand" not in sheet_df.columns.str.lower():
        sheet_df["brand"] = sheet_name
    dfs.append(sheet_df)

raw_df = pd.concat(dfs, ignore_index=True)
# –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
raw_df.columns = raw_df.columns.str.strip().str.lower()
raw_df = raw_df.fillna("")

# –ü—Ä–∏–≤–µ–¥—ë–º –∫ –æ–∂–∏–¥–∞–µ–º—ã–º –∫–æ–ª–æ–Ω–∫–∞–º –∏ forward-fill –ø–æ –±–ª–æ–∫–∞–º
df_prepared = normalize_and_forward_fill(raw_df)

# –ï—Å–ª–∏ size columns –∏–º–µ—é—Ç –¥—Ä—É–≥–∏–µ –∏–º–µ–Ω–∞, –ø—Ä–æ–±—É–µ–º –≤–∞—Ä–∏–∞–Ω—Ç—ã:
if "size us" not in df_prepared.columns and "size" in df_prepared.columns:
    df_prepared["size us"] = df_prepared["size"]

# –°–∫–∞–Ω–∏—Ä—É–µ–º –∫–∞—Ä—Ç–∏–Ω–∫–∏
image_map = scan_images(IMAGE_DIR)

# ----------------------
# –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –∫–∞—Ä—Ç–æ—á–µ–∫: –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ (brand, model, color)
# ----------------------
grouped_rows = []
group_cols = ["brand", "model", "gender", "color"]
if not all(c in df_prepared.columns for c in group_cols):
    st.error("–í —Ç–∞–±–ª–∏—Ü–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏: brand / model / gender / color")
    st.stop()

for (brand, model, gender, color), group in df_prepared.groupby(group_cols, sort=False):
    # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ image-—Å—Ç—Ä–æ–∫–∏ –≤ —ç—Ç–æ–π –≥—Ä—É–ø–ø–µ (–æ–±—ã—á–Ω–æ –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞ —Ü–≤–µ—Ç–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç image)
    images_field = " ".join([str(x).strip() for x in group["image"].unique() if str(x).strip() != ""])
    # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ä–∞–∑–º–µ—Ä—ã (US / EU) –≤ —Å–ø–∏—Å–∫–∏
    sizes_us = [s for s in group["size us"].astype(str).tolist() if str(s).strip() != "" and str(s).strip() != "nan"]
    sizes_eu = [s for s in group.get("size eu", pd.Series([""] * len(group))).astype(str).tolist() if str(s).strip() != "" and str(s).strip() != "nan"]
    # price / preorder / in stock / description –±–µ—Ä–µ–º –∏–∑ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–æ–∫–∏ –≤ –≥—Ä—É–ø–ø–µ (–æ–Ω–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏—Ö)
    first = group.iloc[0]
    price = first.get("price", "")
    preorder = first.get("preorder", "")
    in_stock = first.get("in stock", "")
    description = first.get("description", "")
    # —Å–æ–±–µ—Ä—ë–º SKU-list (–ø–æ–ª–µ–∑–Ω–æ)
    skus = group.get("sku", pd.Series([""] * len(group))).astype(str).tolist()
    grouped_rows.append({
        "brand": brand,
        "model": model,
        "gender": gender,
        "color": color,
        "images_field": images_field,
        "sizes_us": sorted(list(dict.fromkeys([s for s in sizes_us if s]))),
        "sizes_eu": sorted(list(dict.fromkeys([s for s in sizes_eu if s]))),
        "price": price,
        "preorder": preorder,
        "in_stock": in_stock,
        "description": description,
        "skus": skus
    })

cards_df = pd.DataFrame(grouped_rows)

# ----------------------
# –§–∏–ª—å—Ç—Ä—ã / –ü–æ–∏—Å–∫
# ----------------------
st.markdown("")  # spacer
search_text = st.text_input("üîé –ü–æ–∏—Å–∫ –ø–æ –±—Ä–µ–Ω–¥—É/–º–æ–¥–µ–ª–∏/—Ü–≤–µ—Ç—É").strip().lower()

col1, col2, col3, col4 = st.columns(4)
with col1:
    brands = ["–í—Å–µ"] + sorted(cards_df["brand"].dropna().unique().tolist())
    brand_sel = st.selectbox("–ë—Ä–µ–Ω–¥", brands)
with col2:
    models = ["–í—Å–µ"] + sorted(cards_df["model"].dropna().unique().tolist())
    model_sel = st.selectbox("–ú–æ–¥–µ–ª—å", models)
with col3:
    genders = ["–í—Å–µ"] + sorted(cards_df["gender"].dropna().unique().tolist())
    gender_sel = st.selectbox("–ü–æ–ª", genders)
with col4:
    all_sizes = sorted({s for lst in cards_df["sizes_us"] for s in lst if s})
    sizes = ["–í—Å–µ"] + all_sizes
    size_sel = st.selectbox("–†–∞–∑–º–µ—Ä (US)", sizes)

# –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã
filtered = cards_df.copy()
if brand_sel != "–í—Å–µ":
    filtered = filtered[filtered["brand"] == brand_sel]
if model_sel != "–í—Å–µ":
    filtered = filtered[filtered["model"] == model_sel]
if gender_sel != "–í—Å–µ":
    filtered = filtered[filtered["gender"] == gender_sel]
if size_sel != "–í—Å–µ":
    filtered = filtered[filtered["sizes_us"].apply(lambda lst: size_sel in lst)]

if search_text:
    filtered = filtered[filtered.apply(lambda r:
        search_text in str(r["brand"]).lower()
        or search_text in str(r["model"]).lower()
        or search_text in str(r["color"]).lower()
    , axis=1)]

st.markdown("---")

# ----------------------
# –ö–∞—Ä—Ç–æ—á–∫–∏: —Å–µ—Ç–∫–∞ 4 –Ω–∞ —Ä—è–¥
# ----------------------
if filtered.empty:
    st.info("–ü–æ —Ç–µ–∫—É—â–∏–º —Ñ–∏–ª—å—Ç—Ä–∞–º —Ç–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.")
else:
    cols = st.columns(4)
    for idx, r in filtered.reset_index(drop=True).iterrows():
        col = cols[idx % 4]
        with col:
            # –ø–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ø—É—Ç–µ–π –¥–ª—è images_field
            image_paths = first_existing_image(r["images_field"], image_map)
            if image_paths:
                # –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º –ø–µ—Ä–≤—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É
                try:
                    st.image(image_paths[0], use_container_width=True)
                except:
                    if PLACEHOLDER:
                        st.image(PLACEHOLDER, use_container_width=True)
                    else:
                        st.write("No image")
            else:
                if PLACEHOLDER:
                    st.image(PLACEHOLDER, use_container_width=True)
                else:
                    st.write("No image")

            st.markdown(f"**{r['brand']} ‚Äî {r['model']}**")
            st.markdown(f"*–¶–≤–µ—Ç:* {r['color']}")
            st.markdown(f"*–ü–æ–ª:* {r['gender']}")
            try:
                price_disp = int(float(r['price']))
            except:
                price_disp = r['price']
            st.markdown(f"**{price_disp} ‚Ç∏**")

            in_stock_flag = str(r.get("in_stock", "")).strip().lower()
            if in_stock_flag in ["yes", "–¥–∞", "–≤ –Ω–∞–ª–∏—á–∏–∏", "true", "1"]:
                st.markdown("<p style='color:green;'>–í –Ω–∞–ª–∏—á–∏–∏</p>", unsafe_allow_html=True)
            elif str(r.get("preorder", "")).strip().lower() in ["yes", "–¥–∞", "true", "1"]:
                st.markdown("<p style='color:orange;'>–ü—Ä–µ–¥–∑–∞–∫–∞–∑</p>", unsafe_allow_html=True)
            else:
                st.markdown("<p style='color:red;'>–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</p>", unsafe_allow_html=True)

            # –ö–Ω–æ–ø–∫–∞ "–ü–æ–¥—Ä–æ–±–Ω–µ–µ" ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ session_state
            if st.button("–ü–æ–¥—Ä–æ–±–Ω–µ–µ", key=f"more_{idx}"):
                st.session_state["modal_target"] = {
                    "brand": r["brand"],
                    "model": r["model"],
                    "color": r["color"]
                }
                st.experimental_rerun()

# ----------------------
# –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç modal_target ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
# ----------------------
if "modal_target" in st.session_state and st.session_state["modal_target"]:
    target = st.session_state["modal_target"]
    # –Ω–∞–π–¥—ë–º –∏–Ω–¥–µ–∫—Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π –∑–∞–ø–∏—Å–∏ –≤ filtered (–ø–æ brand+model+color)
    match_idx = None
    filtered_list = filtered.reset_index(drop=True)
    for i, rr in filtered_list.iterrows():
        if (rr["brand"] == target["brand"] and rr["model"] == target["model"]
                and rr["color"] == target["color"]):
            match_idx = i
            break

    if match_idx is not None:
        prod = filtered_list.loc[match_idx]

        # –û—Ç–∫—Ä—ã–≤–∞–µ–º modal
        with st.modal(f"{prod['brand']} ‚Äî {prod['model']} ({prod['color']})"):
            # –ì–∞–ª–µ—Ä–µ—è
            imgs = first_existing_image(prod["images_field"], image_map)
            if imgs:
                # –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –≥–∞–ª–µ—Ä–µ—é (–∫–∞–∂–¥–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ –æ—á–µ—Ä–µ–¥–∏)
                for p in imgs:
                    try:
                        st.image(p, use_column_width=True)
                    except:
                        if PLACEHOLDER:
                            st.image(PLACEHOLDER, use_column_width=True)
                        else:
                            st.write("No image")
            else:
                if PLACEHOLDER:
                    st.image(PLACEHOLDER, use_column_width=True)
                else:
                    st.write("No image")

            # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ —Ä–∞–∑–º–µ—Ä—ã
            st.markdown(f"**–¶–µ–Ω–∞:** {int(float(prod['price'])) if str(prod['price']) else prod['price']} ‚Ç∏")
            in_stock_flag = str(prod.get("in_stock", "")).strip().lower()
            if in_stock_flag in ["yes", "–¥–∞", "–≤ –Ω–∞–ª–∏—á–∏–∏", "true", "1"]:
                st.markdown("<p style='color:green;'>–í –Ω–∞–ª–∏—á–∏–∏</p>", unsafe_allow_html=True)
            elif str(prod.get("preorder", "")).strip().lower() in ["yes", "–¥–∞", "true", "1"]:
                st.markdown("<p style='color:orange;'>–ü—Ä–µ–¥–∑–∞–∫–∞–∑</p>", unsafe_allow_html=True)
            else:
                st.markdown("<p style='color:red;'>–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</p>", unsafe_allow_html=True)

            # —Ä–∞–∑–º–µ—Ä—ã
            sizes_us = prod.get("sizes_us", [])
            sizes_eu = prod.get("sizes_eu", [])
            if sizes_us:
                st.markdown("**–†–∞–∑–º–µ—Ä—ã (US):** " + ", ".join(map(str, sizes_us)))
            if sizes_eu:
                st.markdown("**–†–∞–∑–º–µ—Ä—ã (EU):** " + ", ".join(map(str, sizes_eu)))

            # –æ–ø–∏—Å–∞–Ω–∏–µ
            if prod.get("description"):
                st.markdown("**–û–ø–∏—Å–∞–Ω–∏–µ:**")
                st.write(prod.get("description"))

            st.markdown("---")
            # –º–∏–Ω–∏–∞—Ç—é—Ä—ã –¥—Ä—É–≥–∏—Ö —Ü–≤–µ—Ç–æ–≤ —Ç–æ–π –∂–µ –º–æ–¥–µ–ª–∏
            same_model = filtered_list[filtered_list["model"] == prod["model"]]
            other_colors = same_model[same_model["color"] != prod["color"]]
            if not other_colors.empty:
                st.markdown("**–î—Ä—É–≥–∏–µ —Ü–≤–µ—Ç–∞:**")
                cols_thumb = st.columns(max(1, min(6, len(other_colors))))
                for i2, (_, rc) in enumerate(other_colors.iterrows()):
                    with cols_thumb[i2 % len(cols_thumb)]:
                        thumb_imgs = first_existing_image(rc["images_field"], image_map)
                        if thumb_imgs:
                            try:
                                st.image(thumb_imgs[0], width=120)
                            except:
                                if PLACEHOLDER:
                                    st.image(PLACEHOLDER, width=120)
                        else:
                            if PLACEHOLDER:
                                st.image(PLACEHOLDER, width=120)

                        # –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –º–∏–Ω–∏–∞—Ç—é—Ä—ã ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ–º modal –¥–ª—è —ç—Ç–æ–≥–æ —Ü–≤–µ—Ç–∞
                        if st.button(f"–û—Ç–∫—Ä—ã—Ç—å: {rc['color']}", key=f"thumb_{i2}"):
                            st.session_state["modal_target"] = {"brand": rc["brand"], "model": rc["model"], "color": rc["color"]}
                            st.experimental_rerun()

            # –∫–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç—å
            if st.button("–ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ"):
                st.session_state["modal_target"] = None
                st.experimental_rerun()
    else:
        # –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Äî –æ—á–∏—Å—Ç–∏–º
        st.session_state["modal_target"] = None
