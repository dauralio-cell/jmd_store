import streamlit as st
import pandas as pd
import glob
import os
import re

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ---
st.set_page_config(page_title="DENE Store", layout="wide")

# --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è ---
if 'view_details' not in st.session_state:
    st.session_state.view_details = None

# --- –û–±–ª–æ–∂–∫–∞ ---
st.image("data/images/banner.jpg", use_container_width=True)
st.markdown("<h1 style='text-align:center; white-space: nowrap;'>DENE Store. –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h1>", unsafe_allow_html=True)

# --- –ü—É—Ç–∏ –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã ---
CATALOG_PATH = "data/catalog.xlsx"
IMAGES_PATH = "data/images"

# --- –¢–∞–±–ª–∏—Ü–∞ –∫–æ–Ω–≤–µ—Ä—Å–∏–∏ —Ä–∞–∑–º–µ—Ä–æ–≤ US ‚Üî EU ---
size_conversion = {
    "6": "39", "6.5": "39.5", "7": "40", "7.5": "40.5",
    "8": "41", "8.5": "42", "9": "42.5", "9.5": "43",
    "10": "44", "10.5": "44.5", "11": "45", "11.5": "46", "12": "46.5"
}
reverse_conversion = {v: k for k, v in size_conversion.items()}

# --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ ---
def get_image_path(image_names):
    """–ò—â–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ –∏–º–µ–Ω–∏ –∏–∑ –∫–æ–ª–æ–Ω–∫–∏ image (–±–µ—Ä–µ—Ç –ø–µ—Ä–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ —Å–ø–∏—Å–∫–∞)"""
    if not image_names or pd.isna(image_names) or str(image_names).strip() == "":
        return os.path.join(IMAGES_PATH, "no_image.jpg")
    
    image_names_list = str(image_names).strip().split()
    if not image_names_list:
        return os.path.join(IMAGES_PATH, "no_image.jpg")
    
    first_image_name = image_names_list[0]
    
    for ext in ['.jpg', '.jpeg', '.png', '.webp']:
        pattern = os.path.join(IMAGES_PATH, "**", f"{first_image_name}{ext}")
        image_files = glob.glob(pattern, recursive=True)
        if image_files:
            return image_files[0]
        
        pattern_start = os.path.join(IMAGES_PATH, "**", f"{first_image_name}*{ext}")
        image_files = glob.glob(pattern_start, recursive=True)
        if image_files:
            return image_files[0]
    
    return os.path.join(IMAGES_PATH, "no_image.jpg")

def get_all_images_for_product(image_names):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–ª—è —Ç–æ–≤–∞—Ä–∞"""
    if not image_names or pd.isna(image_names) or str(image_names).strip() == "":
        return [os.path.join(IMAGES_PATH, "no_image.jpg")]
    
    image_names_list = str(image_names).strip().split()
    all_images = []
    
    for image_name in image_names_list:
        found = False
        for ext in ['.jpg', '.jpeg', '.png', '.webp']:
            pattern = os.path.join(IMAGES_PATH, "**", f"{image_name}{ext}")
            image_files = glob.glob(pattern, recursive=True)
            if image_files:
                all_images.append(image_files[0])
                found = True
                break
        
        if not found:
            all_images.append(os.path.join(IMAGES_PATH, "no_image.jpg"))
    
    return all_images if all_images else [os.path.join(IMAGES_PATH, "no_image.jpg")]

def get_similar_products(df, current_product):
    """–ù–∞—Ö–æ–¥–∏—Ç —Ç–æ–≤–∞—Ä—ã —Ç–æ–π –∂–µ –º–æ–¥–µ–ª–∏ –Ω–æ –¥—Ä—É–≥–∏—Ö —Ü–≤–µ—Ç–æ–≤"""
    similar = df[
        (df["model_clean"] == current_product["model_clean"]) &
        (df["brand"] == current_product["brand"]) &
        (df["sku"] != current_product["sku"])
    ]
    return similar

# --- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö ---
@st.cache_data(show_spinner=False)
def load_data():
    try:
        # –ß–∏—Ç–∞–µ–º –≤—Å–µ –ª–∏—Å—Ç—ã Excel —Ñ–∞–π–ª–∞
        all_sheets = pd.read_excel(CATALOG_PATH, sheet_name=None)
        
        # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ –ª–∏—Å—Ç—ã –≤ –æ–¥–∏–Ω DataFrame
        df_list = []
        for sheet_name, sheet_data in all_sheets.items():
            df_list.append(sheet_data)
        
        # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
        df = pd.concat(df_list, ignore_index=True)
        df = df.fillna("")

        # –û–±—Ä–∞–±–æ—Ç–∫–∞ –º–æ–¥–µ–ª–∏
        df["model_clean"] = (
            df["model"]
            .str.replace(r"\d{1,2}(\.\d)?(US|EU)", "", regex=True)
            .str.strip()
        )

        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã
        df["size_us"] = df["model"].apply(lambda x: re.search(r"(\d{1,2}(\.\d)?)(?=US)", x))
        df["size_us"] = df["size_us"].apply(lambda m: m.group(1) if m else "")
        df["size_eu"] = df["model"].apply(lambda x: re.search(r"(\d{2}(\.\d)?)(?=EU)", x))
        df["size_eu"] = df["size_eu"].apply(lambda m: m.group(1) if m else "")

        # –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –æ–¥–Ω–æ–≥–æ –∏–∑ —Ä–∞–∑–º–µ—Ä–æ–≤
        df["size_eu"] = df.apply(lambda r: size_conversion.get(r["size_us"], r["size_eu"]), axis=1)
        df["size_us"] = df.apply(lambda r: reverse_conversion.get(r["size_eu"], r["size_us"]), axis=1)

        # –ü–æ–ª –∏ —Ü–≤–µ—Ç
        df["gender"] = df["model"].apply(
            lambda x: "men" if "men" in x.lower() else (
                "women" if "women" in x.lower() else "unisex"
            )
        )
        df["color"] = df["model"].str.extract(
            r"(white|black|blue|red|green|pink|gray|brown)", expand=False
        ).fillna("other")

        # –û–ø–∏—Å–∞–Ω–∏–µ
        if "description" not in df.columns:
            df["description"] = "–û–ø–∏—Å–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ."

        # –ò—Å–∫–ª—é—á–∞–µ–º —Ç–æ–≤–∞—Ä—ã –±–µ–∑ —Ü–µ–Ω—ã –∏–ª–∏ –º–æ–¥–µ–ª–∏
        df = df[df["price"].astype(str).str.strip() != ""]
        df = df[df["model_clean"].astype(str).str.strip() != ""]

        return df
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: {e}")
        return pd.DataFrame()

# --- –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ---
df = load_data()

# --- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å ---
st.sidebar.write("üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê:")
st.sidebar.write("–í—Å–µ–≥–æ —Ç–æ–≤–∞—Ä–æ–≤:", len(df))
st.sidebar.write("–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –±—Ä–µ–Ω–¥—ã:", df["brand"].nunique())
st.sidebar.write("–£–Ω–∏–∫–∞–ª—å–Ω—ã–µ –º–æ–¥–µ–ª–∏:", df["model_clean"].nunique())

# --- –§–∏–ª—å—Ç—Ä—ã ---
st.divider()
st.markdown("### üîé –§–∏–ª—å—Ç—Ä –∫–∞—Ç–∞–ª–æ–≥–∞")

col1, col2, col3, col4, col5, col6 = st.columns(6)
brand_filter = col1.selectbox("–ë—Ä–µ–Ω–¥", ["–í—Å–µ"] + sorted(df["brand"].unique().tolist()))
filtered_df = df if brand_filter == "–í—Å–µ" else df[df["brand"] == brand_filter]

models = sorted(filtered_df["model_clean"].unique().tolist())
model_filter = col2.selectbox("–ú–æ–¥–µ–ª—å", ["–í—Å–µ"] + models)

size_us_filter = col3.selectbox("–†–∞–∑–º–µ—Ä (US)", ["–í—Å–µ"] + sorted(df["size_us"].dropna().unique().tolist()))
size_eu_filter = col4.selectbox("–†–∞–∑–º–µ—Ä (EU)", ["–í—Å–µ"] + sorted(df["size_eu"].dropna().unique().tolist()))
gender_filter = col5.selectbox("–ü–æ–ª", ["–í—Å–µ", "men", "women", "unisex"])
color_filter = col6.selectbox("–¶–≤–µ—Ç", ["–í—Å–µ"] + sorted(df["color"].dropna().unique().tolist()))

# --- –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã ---
filtered_df = df.copy()
if brand_filter != "–í—Å–µ":
    filtered_df = filtered_df[filtered_df["brand"] == brand_filter]
if model_filter != "–í—Å–µ":
    filtered_df = filtered_df[filtered_df["model_clean"] == model_filter]
if size_us_filter != "–í—Å–µ":
    eu_equiv = size_conversion.get(size_us_filter, "")
    filtered_df = filtered_df[
        (filtered_df["size_us"] == size_us_filter) | (filtered_df["size_eu"] == eu_equiv)
    ]
if size_eu_filter != "–í—Å–µ":
    us_equiv = reverse_conversion.get(size_eu_filter, "")
    filtered_df = filtered_df[
        (filtered_df["size_eu"] == size_eu_filter) | (filtered_df["size_us"] == us_equiv)
    ]
if gender_filter != "–í—Å–µ":
    filtered_df = filtered_df[filtered_df["gender"] == gender_filter]
if color_filter != "–í—Å–µ":
    filtered_df = filtered_df[filtered_df["color"] == color_filter]

st.divider()

# --- –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω —Ç–æ–≤–∞—Ä –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ ---
if st.session_state.view_details is not None:
    product_index = st.session_state.view_details
    if 0 <= product_index < len(filtered_df):
        product = filtered_df.iloc[product_index].to_dict()
        all_images = get_all_images_for_product(product["image"])
        similar_products = get_similar_products(df, product)
        
        # –ö–Ω–æ–ø–∫–∞ –Ω–∞–∑–∞–¥
        if st.button("‚Üê –ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–∞–ª–æ–≥—É"):
            st.session_state.view_details = None
            st.rerun()
        
        st.markdown("## üìã –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ")
        
        col1, col2 = st.columns(2)
        
        with col1:
            # –ì–∞–ª–µ—Ä–µ—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
            st.subheader("üì∑ –ì–∞–ª–µ—Ä–µ—è")
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            current_image_index = st.session_state.get('current_image_index', 0)
            st.image(all_images[current_image_index], use_container_width=True)
            
            # –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º
            if len(all_images) > 1:
                col_nav1, col_nav2, col_nav3 = st.columns(3)
                with col_nav1:
                    if st.button("‚¨ÖÔ∏è –ü—Ä–µ–¥—ã–¥—É—â–µ–µ"):
                        new_index = (current_image_index - 1) % len(all_images)
                        st.session_state.current_image_index = new_index
                        st.rerun()
                with col_nav2:
                    st.info(f"–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ {current_image_index + 1} –∏–∑ {len(all_images)}")
                with col_nav3:
                    if st.button("–°–ª–µ–¥—É—é—â–µ–µ ‚û°Ô∏è"):
                        new_index = (current_image_index + 1) % len(all_images)
                        st.session_state.current_image_index = new_index
                        st.rerun()
                
                # –ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
                st.write("**–ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä:**")
                cols = st.columns(len(all_images))
                for idx, col in enumerate(cols):
                    with col:
                        if st.button(f"{idx+1}", key=f"thumb_{idx}"):
                            st.session_state.current_image_index = idx
                            st.rerun()
        
        with col2:
            # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ
            st.subheader("üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è")
            
            st.write(f"**–ë—Ä–µ–Ω–¥:** {product['brand']}")
            st.write(f"**–ú–æ–¥–µ–ª—å:** {product['model_clean']}")
            st.write(f"**–¶–≤–µ—Ç:** {product['color']}")
            st.write(f"**–†–∞–∑–º–µ—Ä US:** {product['size_us'] or '-'}")
            st.write(f"**–†–∞–∑–º–µ—Ä EU:** {product['size_eu'] or '-'}")
            st.write(f"**–ü–æ–ª:** {product['gender']}")
            st.write(f"**–û–ø–∏—Å–∞–Ω–∏–µ:** {product['description']}")
            st.markdown(f"**–¶–µ–Ω–∞:** **<span style='color: #e74c3c; font-size: 24px;'>{int(product['price'])} ‚Ç∏</span>**", unsafe_allow_html=True)
            
            # –î—Ä—É–≥–∏–µ —Ü–≤–µ—Ç–∞
            if not similar_products.empty:
                st.subheader("üé® –î—Ä—É–≥–∏–µ —Ü–≤–µ—Ç–∞")
                for _, similar in similar_products.iterrows():
                    with st.container():
                        col_s1, col_s2, col_s3 = st.columns([1, 2, 1])
                        with col_s1:
                            similar_image = get_image_path(similar["image"])
                            st.image(similar_image, width=60)
                        with col_s2:
                            st.write(f"**–¶–≤–µ—Ç:** {similar['color']}")
                            st.write(f"**–¶–µ–Ω–∞:** {int(similar['price'])} ‚Ç∏")
                        with col_s3:
                            if st.button("üëÄ –°–º–æ—Ç—Ä–µ—Ç—å", key=f"view_{similar['sku']}"):
                                # –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –≤ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–º DataFrame
                                similar_index = filtered_df[filtered_df['sku'] == similar['sku']].index
                                if len(similar_index) > 0:
                                    st.session_state.view_details = similar_index[0]
                                    st.session_state.current_image_index = 0
                                    st.rerun()
            else:
                st.info("üé® –î—Ä—É–≥–∏—Ö —Ü–≤–µ—Ç–æ–≤ –Ω–µ—Ç")
        
        st.divider()
        
    else:
        st.error("–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω")
        if st.button("‚Üê –ù–∞–∑–∞–¥ –∫ –∫–∞—Ç–∞–ª–æ–≥—É"):
            st.session_state.view_details = None
            st.rerun()

else:
    # --- –û–±—ã—á–Ω—ã–π –∫–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤ ---
    st.markdown("## üëü –ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤")

    if len(filtered_df) == 0:
        st.warning("üö´ –¢–æ–≤–∞—Ä—ã –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
    else:
        st.write(f"**–ù–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤: {len(filtered_df)}**")
        
        num_cols = 4
        rows = [filtered_df.iloc[i:i+num_cols] for i in range(0, len(filtered_df), num_cols)]

        for row_idx, row_df in enumerate(rows):
            cols = st.columns(num_cols)
            for col_idx, (col, (_, row)) in enumerate(zip(cols, row_df.iterrows())):
                with col:
                    image_path = get_image_path(row["image"])
                    
                    # –ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞
                    st.image(image_path, use_container_width=True)
                    st.markdown(f"**{row['brand']} {row['model_clean']}**")
                    st.markdown(f"US {row['size_us'] or '-'} | EU {row['size_eu'] or '-'} | {row['color']}")
                    st.markdown(f"{row['description'][:100]}{'...' if len(row['description']) > 100 else ''}")
                    st.markdown(f"**{int(row['price'])} ‚Ç∏**")
                    
                    # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                    if st.button("üëÄ –ü–æ–¥—Ä–æ–±–Ω–µ–µ", key=f"btn_{row_idx}_{col_idx}", use_container_width=True):
                        st.session_state.view_details = row_df.index[col_idx]
                        st.session_state.current_image_index = 0
                        st.rerun()

st.divider()
st.caption("¬© DENE Store 2025")